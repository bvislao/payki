(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{1235:(e,r,t)=>{"use strict";t.d(r,{default:()=>i});var n=t(4248),a=t(8299);function i(){return(0,n.jsx)(a.l$,{position:"top-center",toastOptions:{duration:3e3,style:{fontSize:"0.9rem",borderRadius:"0.75rem",background:"var(--toast-bg)",color:"var(--toast-fg)"},success:{iconTheme:{primary:"#10b981",secondary:"white"}},error:{iconTheme:{primary:"#ef4444",secondary:"white"}}}})}},1578:(e,r,t)=>{"use strict";t.d(r,{default:()=>l});var n=t(4248),a=t(9661),i=t(7637);function s(){let{pending:e}=(0,i.M)();return e<=0?null:(0,n.jsx)("div",{className:"fixed inset-0 z-[9999] bg-black/40 backdrop-blur-sm flex items-center justify-center",children:(0,n.jsxs)("div",{className:"flex items-center gap-3 rounded-2xl bg-white/90 dark:bg-gray-900/90 px-5 py-3 shadow-xl",children:[(0,n.jsx)("span",{className:"inline-block h-4 w-4 animate-spin rounded-full border-2 border-gray-400 border-t-transparent"}),(0,n.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Cargando…"})]})})}function l(e){let{children:r}=e;return(0,n.jsx)(i.o,{children:(0,n.jsxs)(a.O,{children:[r,(0,n.jsx)(s,{})]})})}},4927:(e,r,t)=>{"use strict";t.d(r,{default:()=>g});var n=t(4248),a=t(7642),i=t.n(a),s=t(5519),l=t(9661),o=t(4564),c=t(9410);async function d(){return"serviceWorker"in navigator?await navigator.serviceWorker.register("/sw.js"):null}async function u(e,r){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw Error("Push no soportado en este navegador");if("granted"!==await Notification.requestPermission())throw Error("Permiso de notificaciones denegado");let t=await navigator.serviceWorker.ready,n=await t.pushManager.getSubscription();if(n){let e=n.toJSON().keys;return await r({endpoint:n.endpoint,p256dh:e.p256dh,auth:e.auth}),!0}let a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:function(e){if(!e)throw Error("VAPID public key is empty/undefined");let r=e.trim().replace(/^"+|"+$/g,"").replace(/\s+/g,"").replace(/-/g,"+").replace(/_/g,"/"),t=r.length%4;t&&(r+="=".repeat(4-t));let n="";try{n=atob(r)}catch(e){throw Error("Invalid VAPID public key (not Base64/Base64URL).")}let a=new Uint8Array(n.length);for(let e=0;e<n.length;e++)a[e]=n.charCodeAt(e);return a}(e)}),i=a.toJSON().keys;return await r({endpoint:a.endpoint,p256dh:i.p256dh,auth:i.auth}),!0}var h=t(8299);function m(){let{userId:e}=(0,l.A)(),[r,t]=(0,o.useState)(!1),a="BMoOo9WNPPHr_bTAO1pfRuPNEG1yBAG1iP34WSS-B-AlgIQ_mBh680P8PF5p5NCB4qzo5jpHo6EUHU1vmaCnAog",i=async()=>{let r=function(){var e;let r=[],t=window.isSecureContext||"https:"===location.protocol;t||"localhost"===location.hostname||r.push("El sitio no est\xe1 en HTTPS.");let n="serviceWorker"in navigator;n||r.push("Este navegador no soporta Service Worker.");let a="PushManager"in window;a||r.push("Este navegador no soporta la API de Push.");let i=null==(e=Notification)?void 0:e.permission;"denied"===i&&r.push("Las notificaciones est\xe1n bloqueadas para este sitio.");let s=navigator.userAgent||"",l=/iPad|iPhone|iPod/.test(s)&&!("MSStream"in window),o=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;return l&&!o&&r.push("En iOS debes instalar la PWA en la pantalla de inicio para recibir push."),{ok:0===r.length,reasons:r,info:{isSecure:t,hasSW:n,hasPush:a,perm:i,isIOS:l,isStandalone:o}}}();if(!r.ok)return void(0,h.Ay)("Navegador no soportado para Web Push:\n- "+r.reasons.join("\n- "));if(!e)return(0,h.Ay)("Inicia sesi\xf3n primero");if(!a)return(0,h.Ay)("Falta NEXT_PUBLIC_VAPID_PUBLIC_KEY");try{t(!0),await d(),await u(a,async r=>{let{endpoint:t,p256dh:n,auth:a}=r;await c.N.from("push_subscriptions").upsert({user_id:e,endpoint:t,p256dh:n,auth:a,user_agent:navigator.userAgent},{onConflict:"endpoint"})}),(0,h.Ay)("Notificaciones activadas")}catch(e){h.Ay.error(e instanceof Error?e.message:String(e))}finally{t(!1)}};return(0,n.jsx)("button",{className:"btn-outline",onClick:i,disabled:r,children:r?"ACt…":"Act Not"})}let f=[{href:"/user",label:"Usuario",roles:["passenger","admin"]},{href:"/driver",label:"Conductor",roles:["driver","admin"]},{href:"/admin",label:"Admin",roles:["admin"]}];function p(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter(Boolean).join(" ")}function g(){var e;let{userId:r,email:t,profile:a,signOut:c}=(0,l.A)(),d=(0,s.usePathname)(),[u,h]=(0,o.useState)(!1);(0,o.useEffect)(()=>{h(!1)},[d]);let g=null!=(e=null==a?void 0:a.role)?e:null,b=f.filter(e=>!e.roles||g&&e.roles.includes(g));return(0,n.jsxs)("nav",{className:"container flex items-center justify-between h-14",children:[(0,n.jsxs)(i(),{href:"/","aria-label":"Inicio",className:"flex items-center gap-2 shrink-0",children:[(0,n.jsx)("img",{src:"/logo-bg.svg",alt:"PAYKI",className:"h-7 w-auto"}),(0,n.jsx)("span",{className:"sr-only",children:"PAYKI"})]}),(0,n.jsxs)("div",{className:"hidden md:flex items-center gap-2",children:[b.map(e=>(0,n.jsx)(i(),{href:e.href,className:p("px-3 py-1.5 rounded-xl text-sm transition-colors",d.startsWith(e.href)?"bg-emerald-600 text-white":"hover:bg-gray-100 dark:hover:bg-gray-800"),children:e.label},e.href)),r&&(0,n.jsx)(m,{}),r?(0,n.jsx)("button",{className:"btn-outline",onClick:async()=>{await c(),window.location.href="/"},"aria-label":"Cerrar sesi\xf3n",children:"Cerrar sesi\xf3n"}):(0,n.jsx)(i(),{className:"btn",href:"/login",children:"Login"})]}),(0,n.jsx)("div",{className:"hidden md:block ml-3",children:r&&(0,n.jsxs)("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:["Hola ",(0,n.jsx)("b",{className:"truncate max-w-[220px] inline-block align-bottom",children:t})," \xb7 ",(0,n.jsx)("b",{children:g})]})}),(0,n.jsxs)("button",{className:"md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>h(e=>!e),"aria-expanded":u,"aria-controls":"mobile-menu","aria-label":"Abrir men\xfa",children:[(0,n.jsx)("span",{className:"sr-only",children:"Abrir men\xfa"}),(0,n.jsx)("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",className:"stroke-current",children:(0,n.jsx)("path",{d:"M4 7h16M4 12h16M4 17h16",strokeWidth:"1.8",strokeLinecap:"round"})})]}),(0,n.jsx)("div",{id:"mobile-menu",className:p("md:hidden absolute left-0 right-0 top-14 z-40 border-b border-gray-200/60 dark:border-gray-800 bg-white/95 dark:bg-gray-950/95 backdrop-blur",u?"block":"hidden"),children:(0,n.jsxs)("div",{className:"container py-3 flex flex-col gap-2",children:[r&&(0,n.jsxs)("div",{className:"text-xs text-gray-600 dark:text-gray-300 px-2",children:["Hola ",(0,n.jsx)("b",{children:t})," \xb7 ",(0,n.jsx)("b",{children:g})]}),b.map(e=>(0,n.jsx)(i(),{href:e.href,className:p("px-3 py-2 rounded-xl text-sm",d.startsWith(e.href)?"bg-emerald-600 text-white":"hover:bg-gray-100 dark:hover:bg-gray-800"),children:e.label},e.href)),(0,n.jsxs)("div",{className:"flex items-center gap-2 px-2",children:[r&&(0,n.jsx)(m,{}),r?(0,n.jsx)("button",{className:"btn-outline w-full",onClick:async()=>{await c(),window.location.href="/"},children:"Cerrar sesi\xf3n"}):(0,n.jsx)(i(),{className:"btn w-full",href:"/login",children:"Login"})]})]})})]})}},5519:(e,r,t)=>{"use strict";var n=t(2455);t.o(n,"usePathname")&&t.d(r,{usePathname:function(){return n.usePathname}}),t.o(n,"useRouter")&&t.d(r,{useRouter:function(){return n.useRouter}})},5763:()=>{},7637:(e,r,t)=>{"use strict";t.d(r,{M:()=>l,o:()=>s});var n=t(4248),a=t(4564);let i=(0,a.createContext)(null);function s(e){let{children:r}=e,[t,s]=(0,a.useState)(0),l=()=>s(e=>e+1),o=()=>s(e=>Math.max(0,e-1));(0,a.useEffect)(()=>{let e=window.fetch;return window.fetch=async function(){for(var r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];s(e=>e+1);try{return await e(...t)}finally{s(e=>Math.max(0,e-1))}},()=>{window.fetch=e}},[]);let c=(0,a.useMemo)(()=>({pending:t,start:l,stop:o}),[t]);return(0,n.jsx)(i.Provider,{value:c,children:r})}let l=()=>{let e=(0,a.useContext)(i);if(!e)throw Error("LoadingProvider missing");return e}},8243:(e,r,t)=>{Promise.resolve().then(t.bind(t,1578)),Promise.resolve().then(t.bind(t,9523)),Promise.resolve().then(t.bind(t,4927)),Promise.resolve().then(t.bind(t,8787)),Promise.resolve().then(t.bind(t,1235)),Promise.resolve().then(t.t.bind(t,5763,23))},8787:(e,r,t)=>{"use strict";t.d(r,{default:()=>a});var n=t(4564);function a(){return(0,n.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js",{scope:"/"}).catch(console.error)},[]),null}},9410:(e,r,t)=>{"use strict";t.d(r,{N:()=>n});let n=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9523:(e,r,t)=>{"use strict";t.d(r,{default:()=>s});var n=t(4248),a=t(7642),i=t.n(a);function s(){return(0,n.jsxs)("footer",{className:"container py-8 text-xs text-center text-gray-500",children:["Hecho con ",(0,n.jsx)("span",{"aria-label":"amor",title:"amor",children:"❤"})," —"," ",(0,n.jsx)(i(),{href:"https://github.com/bvislao/payki",className:"underline hover:opacity-80",target:"_blank",rel:"noopener noreferrer",children:"C\xf3digo GitHub"}),"  "," \xa9 ",new Date().getFullYear()," PAYKI"]})}},9661:(e,r,t)=>{"use strict";t.d(r,{A:()=>o,O:()=>l});var n=t(4248),a=t(4564),i=t(9410);let s=(0,a.createContext)(null);function l(e){let{children:r}=e,[t,l]=(0,a.useState)(null),[o,c]=(0,a.useState)(null),[d,u]=(0,a.useState)(null),[h,m]=(0,a.useState)(!0),f=async(e,r)=>{try{let{data:t}=await i.N.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return void u(t);let{data:n,error:a}=await i.N.rpc("ensure_profile",{p_id:e,p_email:null!=r?r:""});if(a){console.error("[ensure_profile] error",a),u(null);return}u(n)}catch(e){console.error("[fetchOrCreate] ",e),u(null)}};(0,a.useEffect)(()=>{let e=!0;(async()=>{var r,t,n,a;let{data:{session:s}}=await i.N.auth.getSession(),o=null!=(n=null==s||null==(r=s.user)?void 0:r.id)?n:null,d=null!=(a=null==s||null==(t=s.user)?void 0:t.email)?a:null;e&&(l(o),c(d),o&&await f(o,d),e&&m(!1))})();let{data:r}=i.N.auth.onAuthStateChange(async(e,r)=>{var t,n,a,i;let s=null!=(a=null==r||null==(t=r.user)?void 0:t.id)?a:null,o=null!=(i=null==r||null==(n=r.user)?void 0:n.email)?i:null;l(s),c(o),s?await f(s,o):u(null)});return()=>{e=!1,r.subscription.unsubscribe()}},[]);let p=async()=>{await i.N.auth.signOut()};return(0,n.jsx)(s.Provider,{value:{userId:t,email:o,profile:d,loading:h,signOut:p},children:r})}let o=()=>{let e=(0,a.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[360,835,642,299,647,516,358],()=>e(e.s=8243)),_N_E=e.O()}]);