(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[418],{451:(e,l,t)=>{"use strict";t.d(l,{A:()=>n});var a=t(4248),s=t(9661),r=t(5519);function n(e){let{role:l,children:t}=e,{loading:n,userId:u,profile:i}=(0,s.A)(),o=(0,r.useRouter)();return n?(0,a.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando…"}):u?(null==i?void 0:i.role)!==l?(0,a.jsx)("div",{className:"p-6",children:"Acceso denegado"}):(0,a.jsx)(a.Fragment,{children:t}):(o.push("/login"),null)}},2786:(e,l,t)=>{"use strict";t.r(l),t.d(l,{default:()=>o});var a=t(4248),s=t(4564),r=t(451),n=t(9410),u=t(9661),i=t(8299);function o(){let{userId:e}=(0,u.A)(),[l,t]=(0,s.useState)(10),[o,c]=(0,s.useState)("4111 1111 1111 1111"),[d,m]=(0,s.useState)("12/28"),[p,x]=(0,s.useState)("123"),[h,N]=(0,s.useState)(!1),v=async t=>{if(t.preventDefault(),e){N(!0);try{var a,s;let t=crypto.randomUUID(),{data:r,error:u}=await n.N.rpc("topup_balance",{p_passenger_id:e,p_amount:Number(l),p_idempotency_key:t});if(u)throw u;i.Ay.success("Recarga exitosa. Nuevo saldo: S/ ".concat(Number(null!=(s=null==r||null==(a=r[0])?void 0:a.new_balance)?s:0).toFixed(2))),history.back()}catch(e){i.Ay.error(e.message)}finally{N(!1)}}};return(0,a.jsx)(r.A,{role:"passenger",children:(0,a.jsxs)("form",{onSubmit:v,className:"max-w-md mx-auto card p-6 space-y-3",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Recargar Saldo"}),(0,a.jsxs)("label",{className:"text-sm",children:["Monto (S/)",(0,a.jsx)("input",{type:"number",step:"0.5",min:.5,className:"mt-1 w-full rounded-xl border px-3 py-2",value:l,onChange:e=>t(Number(e.target.value))})]}),(0,a.jsxs)("label",{className:"text-sm",children:["N\xfamero de Tarjeta",(0,a.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:o,onChange:e=>c(e.target.value)})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,a.jsxs)("label",{className:"text-sm",children:["Vencimiento",(0,a.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:d,onChange:e=>m(e.target.value)})]}),(0,a.jsxs)("label",{className:"text-sm",children:["CVV",(0,a.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:p,onChange:e=>x(e.target.value)})]})]}),(0,a.jsx)("button",{className:"btn w-full",disabled:h,children:h?"Procesando…":"Confirmar Recarga"})]})})}},5519:(e,l,t)=>{"use strict";var a=t(2455);t.o(a,"usePathname")&&t.d(l,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(l,{useRouter:function(){return a.useRouter}})},8283:(e,l,t)=>{Promise.resolve().then(t.bind(t,2786))},9410:(e,l,t)=>{"use strict";t.d(l,{N:()=>a});let a=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,l,t)=>{"use strict";t.d(l,{A:()=>i,O:()=>u});var a=t(4248),s=t(4564),r=t(9410);let n=(0,s.createContext)(null);function u(e){let{children:l}=e,[t,u]=(0,s.useState)(null),[i,o]=(0,s.useState)(null),[c,d]=(0,s.useState)(null),[m,p]=(0,s.useState)(!0),x=async(e,l)=>{try{let{data:t}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return void d(t);let{data:a,error:s}=await r.N.rpc("ensure_profile",{p_id:e,p_email:null!=l?l:""});if(s){console.error("[ensure_profile] error",s),d(null);return}d(a)}catch(e){console.error("[fetchOrCreate] ",e),d(null)}};(0,s.useEffect)(()=>{let e=!0;(async()=>{var l,t,a,s;let{data:{session:n}}=await r.N.auth.getSession(),i=null!=(a=null==n||null==(l=n.user)?void 0:l.id)?a:null,c=null!=(s=null==n||null==(t=n.user)?void 0:t.email)?s:null;e&&(u(i),o(c),i&&await x(i,c),e&&p(!1))})();let{data:l}=r.N.auth.onAuthStateChange(async(e,l)=>{var t,a,s,r;let n=null!=(s=null==l||null==(t=l.user)?void 0:t.id)?s:null,i=null!=(r=null==l||null==(a=l.user)?void 0:a.email)?r:null;u(n),o(i),n?await x(n,i):d(null)});return()=>{e=!1,l.subscription.unsubscribe()}},[]);let h=async()=>{await r.N.auth.signOut()};return(0,a.jsx)(n.Provider,{value:{userId:t,email:i,profile:c,loading:m,signOut:h},children:l})}let i=()=>{let e=(0,s.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=8283)),_N_E=e.O()}]);