(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[422],{451:(e,t,a)=>{"use strict";a.d(t,{A:()=>s});var l=a(4248),r=a(9661),n=a(5519);function s(e){let{role:t,children:a}=e,{loading:s,userId:i,profile:u}=(0,r.A)(),c=(0,n.useRouter)();return s?(0,l.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando…"}):i?(null==u?void 0:u.role)!==t?(0,l.jsx)("div",{className:"p-6",children:"Acceso denegado"}):(0,l.jsx)(l.Fragment,{children:a}):(c.push("/login"),null)}},1046:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var l=a(4248),r=a(4564),n=a(451),s=a(7642),i=a.n(s),u=a(9661),c=a(9410);let o=new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1});async function d(e){let{data:t}=await c.N.from("profiles").select("balance").eq("id",e).maybeSingle(),{data:a}=await c.N.from("transactions").select("id,type,amount,ts,meta").eq("passenger_id",e).in("type",["ride","topup"]).order("ts",{ascending:!1}).limit(15),l=(a||[]).map(e=>{var t,a,l,r;let n=o.format(new Date(e.ts)).replace(",",""),s=((l=null==(t=e.meta)?void 0:t.fare_code)?null!=(r=({troncal:"Troncal",integrada:"Integrada",interburano:"Interburbano",interurbano:"Interburbano",urbano:"Urbano",zonal:"Zonal",general:"General",universitario:"Universitario",escolar:"Escolar"})[String(l).toLowerCase()])?r:String(l):null)||(null==(a=e.meta)?void 0:a.fare_label)||"Pasaje",i="ride"===e.type?"Viaje - ".concat(s," - ").concat(n):"Recarga - Tarjeta - ".concat(n);return{id:e.id,type:e.type,label:i,amount:Number(e.amount),date:e.ts}});return{balance:Number((null==t?void 0:t.balance)||0),recent:l}}function m(){let{userId:e,email:t,profile:a}=(0,u.A)(),[s,c]=(0,r.useState)(0),[o,m]=(0,r.useState)([]),[h,p]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{let t=!0;return(async()=>{if(!e)return p(!1);let a=await d(e);t&&(c(a.balance),m(a.recent),p(!1))})(),()=>{t=!1}},[e]),(0,l.jsx)(n.A,{role:"passenger",children:(0,l.jsxs)("div",{className:"grid gap-6 md:grid-cols-2",children:[(0,l.jsxs)("div",{className:"card p-6 space-y-3",children:[(0,l.jsxs)("h2",{className:"text-xl font-semibold",children:["Hola ",t]}),(0,l.jsxs)("div",{className:"text-sm text-gray-500",children:["Rol: ",(0,l.jsx)("b",{children:null==a?void 0:a.role})]}),(0,l.jsxs)("div",{className:"text-2xl font-bold",children:["Saldo: S/ ",s.toFixed(2)]}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,l.jsx)(i(),{className:"btn w-full",href:"/user/pay",children:"Pagar Pasaje (QR)"}),(0,l.jsx)(i(),{className:"btn-outline w-full",href:"/user/recharge",children:"Recargar Saldo"})]})]}),(0,l.jsxs)("div",{className:"card p-6",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Actividad reciente (\xfaltimos 15)"}),h?(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"Cargando…"}):0===o.length?(0,l.jsx)("div",{className:"text-sm text-gray-500",children:"Sin movimientos."}):(0,l.jsx)("ul",{className:"space-y-2 text-sm",children:o.map(e=>(0,l.jsxs)("li",{className:"flex items-center justify-between",children:[(0,l.jsx)("span",{className:"truncate pr-3",children:e.label}),(0,l.jsxs)("span",{className:"topup"===e.type?"text-green-600":"text-red-600",children:["topup"===e.type?"+":"-","S/ ",e.amount.toFixed(2)]})]},e.id))})]}),(0,l.jsx)(i(),{className:"btn-outline",href:"/user/nearby",children:"Ver unidades cercanas"})]})})}},4091:(e,t,a)=>{Promise.resolve().then(a.bind(a,1046))},5519:(e,t,a)=>{"use strict";var l=a(2455);a.o(l,"usePathname")&&a.d(t,{usePathname:function(){return l.usePathname}}),a.o(l,"useRouter")&&a.d(t,{useRouter:function(){return l.useRouter}})},9410:(e,t,a)=>{"use strict";a.d(t,{N:()=>l});let l=(0,a(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,a)=>{"use strict";a.d(t,{A:()=>u,O:()=>i});var l=a(4248),r=a(4564),n=a(9410);let s=(0,r.createContext)(null);function i(e){let{children:t}=e,[a,i]=(0,r.useState)(null),[u,c]=(0,r.useState)(null),[o,d]=(0,r.useState)(null),[m,h]=(0,r.useState)(!0),p=async(e,t)=>{try{let{data:a}=await n.N.from("profiles").select("*").eq("id",e).maybeSingle();if(a)return void d(a);let{data:l,error:r}=await n.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(r){console.error("[ensure_profile] error",r),d(null);return}d(l)}catch(e){console.error("[fetchOrCreate] ",e),d(null)}};(0,r.useEffect)(()=>{let e=!0;(async()=>{var t,a,l,r;let{data:{session:s}}=await n.N.auth.getSession(),u=null!=(l=null==s||null==(t=s.user)?void 0:t.id)?l:null,o=null!=(r=null==s||null==(a=s.user)?void 0:a.email)?r:null;e&&(i(u),c(o),u&&await p(u,o),e&&h(!1))})();let{data:t}=n.N.auth.onAuthStateChange(async(e,t)=>{var a,l,r,n;let s=null!=(r=null==t||null==(a=t.user)?void 0:a.id)?r:null,u=null!=(n=null==t||null==(l=t.user)?void 0:l.email)?n:null;i(s),c(u),s?await p(s,u):d(null)});return()=>{e=!1,t.subscription.unsubscribe()}},[]);let x=async()=>{await n.N.auth.signOut()};return(0,l.jsx)(s.Provider,{value:{userId:a,email:u,profile:o,loading:m,signOut:x},children:t})}let u=()=>{let e=(0,r.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,642,647,516,358],()=>e(e.s=4091)),_N_E=e.O()}]);