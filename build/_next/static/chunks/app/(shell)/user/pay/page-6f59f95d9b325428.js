(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,a,r)=>{"use strict";r.d(a,{A:()=>i});var l=r(4248),s=r(9661);function i(e){let{role:a,children:r}=e,{userId:i,profile:t,loading:n}=(0,s.A)();return n?(0,l.jsx)("div",{className:"card p-6",children:"Cargandoâ€¦"}):i?t?"passenger"===a&&"passenger"!==t.role?(0,l.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===a&&"driver"!==t.role?(0,l.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===a&&"admin"!==t.role?(0,l.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,l.jsx)(l.Fragment,{children:r}):(0,l.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,l.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},3450:(e,a,r)=>{Promise.resolve().then(r.bind(r,7023))},7023:(e,a,r)=>{"use strict";r.r(a),r.d(a,{default:()=>d});var l=r(4248),s=r(4564),i=r(451),t=r(9661),n=r(9410);function d(){let{userId:e,profile:a}=(0,t.A)(),[r,d]=(0,s.useState)(""),[o,c]=(0,s.useState)(!1),u=async()=>{if(e&&r){c(!0);try{var l;let s=JSON.parse(r),{data:i}=await n.N.from("driver_shifts").select("id,vehicle_id,operator_id,driver_id,status").eq("id",s.shift).eq("status","open").single();if(!i)throw Error("Jornada no v\xe1lida");let t=null!=(l=null==a?void 0:a.benefit)?l:"none",o=await fetch("".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/ride_pay"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({passenger_id:e,driver_id:i.driver_id,vehicle_id:i.vehicle_id,operator_id:i.operator_id,fare_code:s.fare,benefit:t})}),c=await o.json();if(!o.ok)throw Error((null==c?void 0:c.error)||"Error al pagar");alert("Pago de S/ ".concat(c.tx.amount.toFixed(2)," realizado con \xe9xito")),d("")}catch(e){alert(e.message)}finally{c(!1)}}};return(0,l.jsx)(i.A,{role:"passenger",children:(0,l.jsxs)("div",{className:"max-w-lg mx-auto card p-6 space-y-4",children:[(0,l.jsx)("h2",{className:"text-xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,l.jsxs)("div",{className:"border rounded-2xl p-4 bg-gray-50 dark:bg-gray-900/40",children:[(0,l.jsx)("div",{className:"text-sm mb-2",children:"Simula la c\xe1mara pegando el contenido del QR:"}),(0,l.jsx)("textarea",{className:"w-full rounded-xl border p-3 h-28",value:r,onChange:e=>d(e.target.value),placeholder:'{"shift":"<uuid>","fare":"troncal"}'}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("button",{className:"btn",disabled:o||!r,onClick:u,children:"Simular Escaneo Exitoso"}),(0,l.jsx)("button",{className:"btn-outline",onClick:()=>d(""),children:"Limpiar"})]})]})]})})}},9410:(e,a,r)=>{"use strict";r.d(a,{N:()=>l});let l=(0,r(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,r)=>{"use strict";r.d(a,{A:()=>d,AuthProvider:()=>n});var l=r(4248),s=r(4564),i=r(9410);let t=(0,s.createContext)(null);function n(e){let{children:a}=e,[r,n]=(0,s.useState)(null),[d,o]=(0,s.useState)(null),[c,u]=(0,s.useState)(null),[p,h]=(0,s.useState)(!0),m=async(e,a)=>{let{data:r}=await i.N.from("profiles").select("*").eq("id",e).maybeSingle();if(r)return void u(r);let{data:l,error:s}=await i.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(s){console.error("[ensure_profile rpc] error",s),u(null);return}u(null!=l?l:null)};(0,s.useEffect)(()=>{(async()=>{var e,a,r,l,s,t;let{data:d}=await i.N.auth.getSession(),c=null!=(s=null==(a=d.session)||null==(e=a.user)?void 0:e.id)?s:null,u=null!=(t=null==(l=d.session)||null==(r=l.user)?void 0:r.email)?t:null;n(c),o(u),c&&await m(c,u),h(!1)})();let{data:e}=i.N.auth.onAuthStateChange(async(e,a)=>{var r,l,s,i;let t=null!=(s=null==a||null==(r=a.user)?void 0:r.id)?s:null,d=null!=(i=null==a||null==(l=a.user)?void 0:l.email)?i:null;n(t),o(d),t?await m(t,d):u(null)});return()=>{e.subscription.unsubscribe()}},[]);let v=async()=>{await i.N.auth.signOut()};return(0,l.jsx)(t.Provider,{value:{userId:r,email:d,profile:c,loading:p,signOut:v},children:a})}let d=()=>{let e=(0,s.useContext)(t);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);