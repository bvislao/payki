(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var r=n(4248),a=n(9661);function l(e){let{role:t,children:n}=e,{userId:l,profile:s,loading:i}=(0,a.A)();return i?(0,r.jsx)("div",{className:"card p-6",children:"Cargando…"}):l?s?"passenger"===t&&"passenger"!==s.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===t&&"driver"!==s.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===t&&"admin"!==s.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,r.jsx)(r.Fragment,{children:n}):(0,r.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,r.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},473:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(t,{bindSnapshot:function(){return s},createAsyncLocalStorage:function(){return l},createSnapshot:function(){return i}});let n=Object.defineProperty(Error("Invariant: AsyncLocalStorage accessed in runtime where it is not available"),"__NEXT_ERROR_CODE",{value:"E504",enumerable:!1,configurable:!0});class r{disable(){throw n}getStore(){}run(){throw n}exit(){throw n}enterWith(){throw n}static bind(e){return e}}let a="undefined"!=typeof globalThis&&globalThis.AsyncLocalStorage;function l(){return a?new a:new r}function s(e){return a?a.bind(e):r.bind(e)}function i(){return a?a.snapshot():function(e,...t){return e(...t)}}},1605:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a}});let r=n(2632)._(n(9757));function a(e,t){var n;let a={};"function"==typeof e&&(a.loader=e);let l={...a,...t};return(0,r.default)({...l,modules:null==(n=l.loadableGenerated)?void 0:n.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},2963:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorageInstance",{enumerable:!0,get:function(){return r}});let r=(0,n(473).createAsyncLocalStorage)()},3450:(e,t,n)=>{Promise.resolve().then(n.bind(n,5944))},5714:(e,t,n)=>{"use strict";function r(e){let{reason:t,children:n}=e;return n}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return r}}),n(238)},5944:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>h});var r=n(4248),a=n(4564),l=n(451),s=n(9661),i=n(9410),o=n(8440),u=n(8299),c=n(1605),d=n.n(c);let f=d()(()=>n.e(648).then(n.bind(n,7899)).then(e=>e.QrReader),{loadableGenerated:{webpack:()=>[7899]},ssr:!1});function v(e){let{onText:t,height:n=320}=e,[l,s]=(0,a.useState)(!1),[i,o]=(0,a.useState)([]),[u,c]=(0,a.useState)(void 0),d=(0,a.useRef)(0);return(0,a.useEffect)(()=>{var e;(null==(e=navigator.mediaDevices)?void 0:e.enumerateDevices)&&navigator.mediaDevices.enumerateDevices().then(e=>{var t;let n=e.filter(e=>"videoinput"===e.kind);o(n);let r=n.find(e=>/back|trase|rear|environment/i.test(e.label));c(null==(t=null!=r?r:n[0])?void 0:t.deviceId)}).catch(()=>{})},[]),(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto",children:[l?null:(0,r.jsx)("button",{className:"btn w-full mb-3",onClick:()=>s(!0),children:"Activar c\xe1mara"}),l&&i.length>1&&(0,r.jsxs)("label",{className:"block text-sm mb-2",children:["C\xe1mara",(0,r.jsx)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:null!=u?u:"",onChange:e=>c(e.target.value||void 0),children:i.map(e=>(0,r.jsx)("option",{value:e.deviceId,children:e.label||"C\xe1mara ".concat(e.deviceId.slice(0,4),"…")},e.deviceId))})]}),(0,r.jsxs)("div",{className:"relative w-full rounded-2xl border overflow-hidden bg-black/40",style:{height:n},children:[l?(0,r.jsx)(f,{constraints:{...u?{deviceId:{exact:u}}:{facingMode:"environment"}},onResult:e=>{e&&(e=>{let n=Date.now();n-d.current<1200||(d.current=n,t(e))})(e.getText())},videoContainerStyle:{width:"100%",height:"100%"},videoStyle:{width:"100%",height:"100%",objectFit:"cover"}}):(0,r.jsx)("div",{className:"absolute inset-0 grid place-items-center text-white/80 text-sm",children:"Permite c\xe1mara y pulsa “Activar c\xe1mara”"}),(0,r.jsx)("div",{className:"pointer-events-none absolute inset-0",children:(0,r.jsx)("div",{className:"absolute inset-8 border-2 border-white/70 rounded-xl"})})]}),(0,r.jsxs)("ul",{className:"mt-3 text-xs text-gray-500 space-y-1",children:[(0,r.jsx)("li",{children:"• En iPhone/Safari necesitas HTTPS o localhost, y dar permisos."}),(0,r.jsxs)("li",{children:["• Si la vista es muy peque\xf1a, aumenta el alto (prop ",(0,r.jsx)("code",{children:"height"}),")."]})]})]})}function h(){let{userId:e}=(0,s.A)(),[t,n]=(0,a.useState)(!1),[c,d]=(0,a.useState)(""),[f,h]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{var e,t;let n=await (null==(t=navigator.mediaDevices)||null==(e=t.enumerateDevices)?void 0:e.call(t)),r=null==n?void 0:n.some(e=>"videoinput"===e.kind);h(null!=r&&r)}catch(e){h(!1)}})()},[]);let m=async t=>{var r,a,l,s,c;let d,f;try{if(t.startsWith("http")||t.startsWith("payki://")){let e=new URL(t.replace("payki://","https://payki.local/"));d=e.searchParams.get("shift")||void 0,f=e.searchParams.get("fare")||void 0}else{let e=JSON.parse(t);d=e.shift,f=e.fare}}catch(e){u.Ay.error("Formato de QR no v\xe1lido");return}if(!d||!f)return void u.Ay.error("Faltan datos en el QR");if(!e)return void u.Ay.error("Inicia sesi\xf3n");n(!0);try{let t=null==(r=(await i.N.auth.getSession()).data.session)?void 0:r.access_token,n=crypto.randomUUID(),c=await (0,o.Tx)("ride_pay",{passenger_id:e,shift:d,fare:f,idempotencyKey:n},t),v=null!=(a=null==c?void 0:c.tx)?a:null,h=null!=(s=null!=(l=null==v?void 0:v.amount)?l:null==v?void 0:v.tx_amount)?s:null;if(!(null==c?void 0:c.ok)||Number.isNaN(h))throw Error("Transacci\xf3n inv\xe1lida");u.Ay.success("Pago realizado: S/ ".concat(h.toFixed(2)))}catch(e){u.Ay.error(null!=(c=null==e?void 0:e.message)?c:"Error al pagar")}finally{n(!1)}};return(0,r.jsx)(l.A,{role:"passenger",children:(0,r.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-4",children:[(0,r.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,r.jsx)(v,{onText:m,height:360}),(0,r.jsx)("button",{className:"btn w-full mt-3",disabled:t,children:t?"Procesando…":"Listo"})]})})}d()(()=>n.e(648).then(n.bind(n,7899)).then(e=>e.QrReader),{loadableGenerated:{webpack:()=>[7899]},ssr:!1})},6064:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorage",{enumerable:!0,get:function(){return r.workAsyncStorageInstance}});let r=n(2963)},8440:(e,t,n)=>{"use strict";n.d(t,{Tx:()=>a,c9:()=>l});var r=n(9410);async function a(e,t,n){let r="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),a=await fetch("".concat(r,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:"Bearer ".concat(n)}:{}},body:JSON.stringify(t)}),l=await a.text(),s=null;try{s=l?JSON.parse(l):null}catch(e){}if(!a.ok)throw Error(s&&s.error?s.error:l||a.statusText);return s}async function l(e,t,n){var l;let s=null==(l=(await r.N.auth.getSession()).data.session)?void 0:l.access_token;if(!s)throw Error("No auth");return a("send_broadcast",{title:e,body:t,url:n},s)}},9167:(e,t,n)=>{"use strict";function r(e){let{moduleIds:t}=e;return null}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadChunks",{enumerable:!0,get:function(){return r}}),n(4248),n(133),n(6064),n(1181)},9410:(e,t,n)=>{"use strict";n.d(t,{N:()=>r});let r=(0,n(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,n)=>{"use strict";n.d(t,{A:()=>o,AuthProvider:()=>i});var r=n(4248),a=n(4564),l=n(9410);let s=(0,a.createContext)(null);function i(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[f,v]=(0,a.useState)(!0),h=async(e,t)=>{let{data:n}=await l.N.from("profiles").select("*").eq("id",e).maybeSingle();if(n)return void d(n);let{data:r,error:a}=await l.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(a){console.error("[ensure_profile rpc] error",a),d(null);return}d(null!=r?r:null)};(0,a.useEffect)(()=>{(async()=>{var e,t,n,r,a,s;let{data:o}=await l.N.auth.getSession(),c=null!=(a=null==(t=o.session)||null==(e=t.user)?void 0:e.id)?a:null,d=null!=(s=null==(r=o.session)||null==(n=r.user)?void 0:n.email)?s:null;i(c),u(d),c&&await h(c,d),v(!1)})();let{data:e}=l.N.auth.onAuthStateChange(async(e,t)=>{var n,r,a,l;let s=null!=(a=null==t||null==(n=t.user)?void 0:n.id)?a:null,o=null!=(l=null==t||null==(r=t.user)?void 0:r.email)?l:null;i(s),u(o),s?await h(s,o):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let m=async()=>{await l.N.auth.signOut()};return(0,r.jsx)(s.Provider,{value:{userId:n,email:o,profile:c,loading:f,signOut:m},children:t})}let o=()=>{let e=(0,a.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}},9757:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o}});let r=n(4248),a=n(4564),l=n(5714);function s(e){return{default:e&&"default"in e?e.default:e}}n(9167);let i={loader:()=>Promise.resolve(s(()=>null)),loading:null,ssr:!0},o=function(e){let t={...i,...e},n=(0,a.lazy)(()=>t.loader().then(s)),o=t.loading;function u(e){let s=o?(0,r.jsx)(o,{isLoading:!0,pastDelay:!0,error:null}):null,i=!t.ssr||!!t.loading,u=i?a.Suspense:a.Fragment,c=t.ssr?(0,r.jsxs)(r.Fragment,{children:[null,(0,r.jsx)(n,{...e})]}):(0,r.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,r.jsx)(n,{...e})});return(0,r.jsx)(u,{...i?{fallback:s}:{},children:c})}return u.displayName="LoadableComponent",u}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);