(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var r=n(4248),a=n(9661);function l(e){let{role:t,children:n}=e,{userId:l,profile:i,loading:s}=(0,a.A)();return s?(0,r.jsx)("div",{className:"card p-6",children:"Cargando…"}):l?i?"passenger"===t&&"passenger"!==i.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===t&&"driver"!==i.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===t&&"admin"!==i.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,r.jsx)(r.Fragment,{children:n}):(0,r.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,r.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},473:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(t,{bindSnapshot:function(){return i},createAsyncLocalStorage:function(){return l},createSnapshot:function(){return s}});let n=Object.defineProperty(Error("Invariant: AsyncLocalStorage accessed in runtime where it is not available"),"__NEXT_ERROR_CODE",{value:"E504",enumerable:!1,configurable:!0});class r{disable(){throw n}getStore(){}run(){throw n}exit(){throw n}enterWith(){throw n}static bind(e){return e}}let a="undefined"!=typeof globalThis&&globalThis.AsyncLocalStorage;function l(){return a?new a:new r}function i(e){return a?a.bind(e):r.bind(e)}function s(){return a?a.snapshot():function(e,...t){return e(...t)}}},1605:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a}});let r=n(2632)._(n(9757));function a(e,t){var n;let a={};"function"==typeof e&&(a.loader=e);let l={...a,...t};return(0,r.default)({...l,modules:null==(n=l.loadableGenerated)?void 0:n.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},2963:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorageInstance",{enumerable:!0,get:function(){return r}});let r=(0,n(473).createAsyncLocalStorage)()},3450:(e,t,n)=>{Promise.resolve().then(n.bind(n,6300))},5714:(e,t,n)=>{"use strict";function r(e){let{reason:t,children:n}=e;return n}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return r}}),n(238)},6064:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorage",{enumerable:!0,get:function(){return r.workAsyncStorageInstance}});let r=n(2963)},6300:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>f});var r=n(4248),a=n(4564),l=n(451),i=n(9661),s=n(9410),o=n(8440),u=n(8299),c=n(1605);let d=n.n(c)()(()=>n.e(648).then(n.bind(n,7899)).then(e=>e.QrReader),{loadableGenerated:{webpack:()=>[7899]},ssr:!1});function f(){let{userId:e}=(0,i.A)(),[t,n]=(0,a.useState)(!1),[c,f]=(0,a.useState)(""),[p,h]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{var e,t;let n=await (null==(t=navigator.mediaDevices)||null==(e=t.enumerateDevices)?void 0:e.call(t)),r=null==n?void 0:n.some(e=>"videoinput"===e.kind);h(null!=r&&r)}catch(e){h(!1)}})()},[]);let m=async t=>{let r;if(!e)return u.Ay.error("Inicia sesi\xf3n");try{if(!(r=JSON.parse(t)).shift||!r.fare)throw Error("Formato inv\xe1lido")}catch(e){return u.Ay.error("QR inv\xe1lido")}n(!0);try{var a;let t=null==(a=(await s.N.auth.getSession()).data.session)?void 0:a.access_token;if(!t)throw Error("Sin sesi\xf3n");let n=crypto.randomUUID(),l=await (0,o.Tx)("ride_pay",{passenger_id:e,shift:r.shift,fare:r.fare,idempotencyKey:n},t),{id:i,amount:c}=function(e){var t,n,r,a,l;let i=null!=(t=null==e?void 0:e.tx)?t:null,s=null!=(r=null!=(n=null==i?void 0:i.id)?n:null==i?void 0:i.tx_id)?r:null,o=null!=(l=null!=(a=null==i?void 0:i.amount)?a:null==i?void 0:i.tx_amount)?l:null;return{id:s,amount:null==o?null:Number(o)}}(l);if(!(null==l?void 0:l.ok)||null==c||Number.isNaN(c))throw Error("Transacci\xf3n inv\xe1lida");u.Ay.success("Pago realizado: S/ ".concat(c.toFixed(2))),f("")}catch(t){let e=(null==t?void 0:t.message)||"";e.includes("NO_VEHICLE_ASSIGNED")?u.Ay.error("Jornada sin veh\xedculo"):e.includes("SHIFT_CLOSED")?u.Ay.error("Jornada finalizada"):e.includes("FARE_NOT_FOUND")?u.Ay.error("Tarifa no v\xe1lida"):e.includes("INSUFFICIENT_FUNDS")?u.Ay.error("Saldo insuficiente"):u.Ay.error(e||"Error al pagar")}finally{n(!1)}},[v,y]=(0,a.useState)(0);return(0,r.jsx)(l.A,{role:"passenger",children:(0,r.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-5",children:[(0,r.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"text-sm text-gray-400",children:["Apunta la c\xe1mara al QR del conductor. El QR contiene un JSON como: ",'{ "shift": "<uuid>", "fare": "troncal" }']}),p?(0,r.jsx)("div",{className:"overflow-hidden rounded-2xl border",children:(0,r.jsx)(d,{constraints:{facingMode:"environment"},onResult:e=>{if(!e)return;let t=Date.now();window.__lastScan&&t-window.__lastScan<1500||(window.__lastScan=t,m(e.getText()))},videoContainerStyle:{width:"100%",height:"100%"},videoStyle:{width:"100%",height:"100%",objectFit:"cover"}})}):!1===p?(0,r.jsx)("div",{className:"rounded-xl border p-4 text-sm text-amber-600",children:"No se detect\xf3 c\xe1mara (o el navegador no dio permiso). Usa la entrada manual m\xe1s abajo."}):(0,r.jsx)("div",{className:"text-sm text-gray-400",children:"Comprobando c\xe1mara…"})]}),(0,r.jsxs)("div",{className:"rounded-2xl border p-4 space-y-3",children:[(0,r.jsx)("div",{className:"text-sm text-gray-400",children:"\xbfNo puedes usar la c\xe1mara? Pega el contenido del QR:"}),(0,r.jsx)("textarea",{className:"w-full rounded-xl border px-3 py-2 min-h-[120px] bg-white dark:bg-gray-900",placeholder:'{"shift":"<uuid>","fare":"troncal"}',value:c,onChange:e=>f(e.target.value)}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("button",{className:"btn",disabled:t,onClick:()=>m(c),children:t?"Procesando…":"Pagar con payload"}),(0,r.jsx)("button",{className:"btn-outline",onClick:()=>f(""),children:"Limpiar"})]})]})]})})}},8440:(e,t,n)=>{"use strict";n.d(t,{Tx:()=>a,c9:()=>l});var r=n(9410);async function a(e,t,n){let r="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),a=await fetch("".concat(r,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:"Bearer ".concat(n)}:{}},body:JSON.stringify(t)}),l=await a.text(),i=null;try{i=l?JSON.parse(l):null}catch(e){}if(!a.ok)throw Error(i&&i.error?i.error:l||a.statusText);return i}async function l(e,t,n){var l;let i=null==(l=(await r.N.auth.getSession()).data.session)?void 0:l.access_token;if(!i)throw Error("No auth");return a("send_broadcast",{title:e,body:t,url:n},i)}},9167:(e,t,n)=>{"use strict";function r(e){let{moduleIds:t}=e;return null}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadChunks",{enumerable:!0,get:function(){return r}}),n(4248),n(133),n(6064),n(1181)},9410:(e,t,n)=>{"use strict";n.d(t,{N:()=>r});let r=(0,n(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,n)=>{"use strict";n.d(t,{A:()=>o,AuthProvider:()=>s});var r=n(4248),a=n(4564),l=n(9410);let i=(0,a.createContext)(null);function s(e){let{children:t}=e,[n,s]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[f,p]=(0,a.useState)(!0),h=async(e,t)=>{let{data:n}=await l.N.from("profiles").select("*").eq("id",e).maybeSingle();if(n)return void d(n);let{data:r,error:a}=await l.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(a){console.error("[ensure_profile rpc] error",a),d(null);return}d(null!=r?r:null)};(0,a.useEffect)(()=>{(async()=>{var e,t,n,r,a,i;let{data:o}=await l.N.auth.getSession(),c=null!=(a=null==(t=o.session)||null==(e=t.user)?void 0:e.id)?a:null,d=null!=(i=null==(r=o.session)||null==(n=r.user)?void 0:n.email)?i:null;s(c),u(d),c&&await h(c,d),p(!1)})();let{data:e}=l.N.auth.onAuthStateChange(async(e,t)=>{var n,r,a,l;let i=null!=(a=null==t||null==(n=t.user)?void 0:n.id)?a:null,o=null!=(l=null==t||null==(r=t.user)?void 0:r.email)?l:null;s(i),u(o),i?await h(i,o):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let m=async()=>{await l.N.auth.signOut()};return(0,r.jsx)(i.Provider,{value:{userId:n,email:o,profile:c,loading:f,signOut:m},children:t})}let o=()=>{let e=(0,a.useContext)(i);if(!e)throw Error("AuthProvider missing");return e}},9757:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o}});let r=n(4248),a=n(4564),l=n(5714);function i(e){return{default:e&&"default"in e?e.default:e}}n(9167);let s={loader:()=>Promise.resolve(i(()=>null)),loading:null,ssr:!0},o=function(e){let t={...s,...e},n=(0,a.lazy)(()=>t.loader().then(i)),o=t.loading;function u(e){let i=o?(0,r.jsx)(o,{isLoading:!0,pastDelay:!0,error:null}):null,s=!t.ssr||!!t.loading,u=s?a.Suspense:a.Fragment,c=t.ssr?(0,r.jsxs)(r.Fragment,{children:[null,(0,r.jsx)(n,{...e})]}):(0,r.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,r.jsx)(n,{...e})});return(0,r.jsx)(u,{...s?{fallback:i}:{},children:c})}return u.displayName="LoadableComponent",u}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);