(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,t,a)=>{"use strict";a.d(t,{A:()=>n});var r=a(4248),l=a(9661),s=a(5519);function n(e){let{role:t,children:a}=e,{loading:n,userId:i,profile:c}=(0,l.A)(),u=(0,s.useRouter)();return n?(0,r.jsx)("div",{className:"p-6 text-sm text-gray-500",children:"Cargando…"}):i?(null==c?void 0:c.role)!==t?(0,r.jsx)("div",{className:"p-6",children:"Acceso denegado"}):(0,r.jsx)(r.Fragment,{children:a}):(u.push("/login"),null)}},3450:(e,t,a)=>{Promise.resolve().then(a.bind(a,3814))},3814:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>h});var r=a(4248),l=a(4564),s=a(451),n=a(9661),i=a(9410),c=a(8440),u=a(8299),o=a(7807);function d(e){let{onText:t,height:a=360}=e,[s,n]=(0,l.useState)(!1),[i,c]=(0,l.useState)([]),[u,d]=(0,l.useState)(void 0),[v,h]=(0,l.useState)("Pulsa “Activar c\xe1mara”"),m=(0,l.useRef)(null),x=(0,l.useRef)(null),p=(0,l.useRef)(null),f=(0,l.useRef)(0);(0,l.useEffect)(()=>{(async()=>{var e;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop())}catch(e){}let t=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);c(t);let a=t.find(e=>/back|rear|environment|trase/i.test(e.label));d(null==(e=null!=a?a:t[0])?void 0:e.deviceId)})().catch(()=>{})},[]);let y=()=>{var e,t,a;null==(e=p.current)||e.stop(),p.current=null,((null==(a=m.current)||null==(t=a.srcObject)?void 0:t.getTracks())||[]).forEach(e=>e.stop()),m.current&&(m.current.srcObject=null)};(0,l.useEffect)(()=>()=>y(),[]);let g=async()=>{if(m.current)try{n(!0),h("Iniciando c\xe1mara…"),y(),x.current||(x.current=new o.wg),p.current=await x.current.decodeFromVideoDevice(u,m.current,(e,a,r)=>{if(e){h("QR le\xeddo ✅");var l=e.getText();let a=Date.now();a-f.current<1200||(f.current=a,t(l))}}),h("C\xe1mara activa ✅")}catch(e){h("Error: ".concat((null==e?void 0:e.name)||(null==e?void 0:e.message)||e))}};return(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto",children:[(0,r.jsxs)("div",{className:"grid gap-2 mb-3",children:[(0,r.jsxs)("label",{className:"text-sm",children:["C\xe1mara",(0,r.jsx)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:null!=u?u:"",onChange:e=>d(e.target.value||void 0),children:i.map(e=>(0,r.jsx)("option",{value:e.deviceId,children:e.label||"C\xe1mara ".concat(e.deviceId.slice(0,4),"…")},e.deviceId))})]}),(0,r.jsx)("button",{className:"btn",onClick:g,children:"Activar c\xe1mara"})]}),(0,r.jsxs)("div",{className:"relative w-full rounded-2xl border overflow-hidden bg-black/40",style:{height:a},children:[(0,r.jsx)("video",{ref:m,muted:!0,playsInline:!0,autoPlay:!0,style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),(0,r.jsx)("div",{className:"pointer-events-none absolute inset-0",children:(0,r.jsx)("div",{className:"absolute inset-8 border-2 border-white/70 rounded-xl"})})]}),(0,r.jsx)("div",{className:"text-xs mt-2 text-gray-500",children:v}),(0,r.jsxs)("ul",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[(0,r.jsx)("li",{children:"• iPhone/Safari/PWA: HTTPS o localhost y dar permisos de c\xe1mara."}),(0,r.jsx)("li",{children:"• Si queda negra, cambia de c\xe1mara en el selector y vuelve a “Activar c\xe1mara”."})]})]})}var v=a(5519);function h(){let e=(0,v.useRouter)(),{userId:t}=(0,n.A)(),[a,o]=(0,l.useState)(!1),[h,m]=(0,l.useState)(""),[x,p]=(0,l.useState)(null);(0,l.useEffect)(()=>{(async()=>{try{var e,t;let a=await (null==(t=navigator.mediaDevices)||null==(e=t.enumerateDevices)?void 0:e.call(t)),r=null==a?void 0:a.some(e=>"videoinput"===e.kind);p(null!=r&&r)}catch(e){p(!1)}})()},[]);let f=async a=>{var r,l,s,n,o;let d,v;try{if(a.startsWith("http")||a.startsWith("payki://")){let e=new URL(a.replace("payki://","https://payki.local/"));d=e.searchParams.get("shift")||void 0,v=e.searchParams.get("fare")||void 0}else{let e=JSON.parse(a);d=e.shift,v=e.fare}}catch(e){u.Ay.error("QR inv\xe1lido");return}if(!d||!v)return void u.Ay.error("QR incompleto");if(!t)return void u.Ay.error("Inicia sesi\xf3n");try{let a=null==(r=(await i.N.auth.getSession()).data.session)?void 0:r.access_token,o=crypto.randomUUID(),h=await (0,c.Tx)("ride_pay",{passenger_id:t,shift:d,fare:v,idempotencyKey:o},a),m=null!=(l=null==h?void 0:h.tx)?l:null,x=null!=(n=null!=(s=null==m?void 0:m.amount)?s:null==m?void 0:m.tx_amount)?n:null;if(!(null==h?void 0:h.ok)||Number.isNaN(x))throw Error("Transacci\xf3n inv\xe1lida");u.Ay.success("Pago realizado: S/ ".concat(x.toFixed(2))),e.push("/user")}catch(e){u.Ay.error(null!=(o=null==e?void 0:e.message)?o:"Error al pagar")}};return(0,r.jsx)(s.A,{role:"passenger",children:(0,r.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-4",children:[(0,r.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,r.jsx)(d,{onText:f,height:360}),(0,r.jsx)("button",{className:"btn w-full mt-3",disabled:a,children:a?"Procesando…":"Listo"})]})})}},8440:(e,t,a)=>{"use strict";a.d(t,{Tx:()=>l,c9:()=>s});var r=a(9410);async function l(e,t,a){let r="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),l=await fetch("".concat(r,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:"Bearer ".concat(a)}:{}},body:JSON.stringify(t)}),s=await l.text(),n=null;try{n=s?JSON.parse(s):null}catch(e){}if(!l.ok)throw Error(n&&n.error?n.error:s||l.statusText);return n}async function s(e,t,a){var s;let n=null==(s=(await r.N.auth.getSession()).data.session)?void 0:s.access_token;if(!n)throw Error("No auth");return l("send_broadcast",{title:e,body:t,url:a},n)}},9410:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,a)=>{"use strict";a.d(t,{A:()=>c,O:()=>i});var r=a(4248),l=a(4564),s=a(9410);let n=(0,l.createContext)(null);function i(e){let{children:t}=e,[a,i]=(0,l.useState)(null),[c,u]=(0,l.useState)(null),[o,d]=(0,l.useState)(null),[v,h]=(0,l.useState)(!0),m=async(e,t)=>{try{let{data:a}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();if(a)return void d(a);let{data:r,error:l}=await s.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(l){console.error("[ensure_profile] error",l),d(null);return}d(r)}catch(e){console.error("[fetchOrCreate] ",e),d(null)}};(0,l.useEffect)(()=>{let e=!0;(async()=>{var t,a,r,l;let{data:{session:n}}=await s.N.auth.getSession(),c=null!=(r=null==n||null==(t=n.user)?void 0:t.id)?r:null,o=null!=(l=null==n||null==(a=n.user)?void 0:a.email)?l:null;e&&(i(c),u(o),c&&await m(c,o),e&&h(!1))})();let{data:t}=s.N.auth.onAuthStateChange(async(e,t)=>{var a,r,l,s;let n=null!=(l=null==t||null==(a=t.user)?void 0:a.id)?l:null,c=null!=(s=null==t||null==(r=t.user)?void 0:r.email)?s:null;i(n),u(c),n?await m(n,c):d(null)});return()=>{e=!1,t.subscription.unsubscribe()}},[]);let x=async()=>{await s.N.auth.signOut()};return(0,r.jsx)(n.Provider,{value:{userId:a,email:c,profile:o,loading:v,signOut:x},children:t})}let c=()=>{let e=(0,l.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,953,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);