(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,r,t)=>{"use strict";t.d(r,{A:()=>l});var n=t(4248),a=t(9661);function l(e){let{role:r,children:t}=e,{userId:l,profile:s,loading:i}=(0,a.A)();return i?(0,n.jsx)("div",{className:"card p-6",children:"Cargando…"}):l?s?"passenger"===r&&"passenger"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===r&&"driver"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===r&&"admin"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,n.jsx)(n.Fragment,{children:t}):(0,n.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,n.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},473:(e,r)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),!function(e,r){for(var t in r)Object.defineProperty(e,t,{enumerable:!0,get:r[t]})}(r,{bindSnapshot:function(){return s},createAsyncLocalStorage:function(){return l},createSnapshot:function(){return i}});let t=Object.defineProperty(Error("Invariant: AsyncLocalStorage accessed in runtime where it is not available"),"__NEXT_ERROR_CODE",{value:"E504",enumerable:!1,configurable:!0});class n{disable(){throw t}getStore(){}run(){throw t}exit(){throw t}enterWith(){throw t}static bind(e){return e}}let a="undefined"!=typeof globalThis&&globalThis.AsyncLocalStorage;function l(){return a?new a:new n}function s(e){return a?a.bind(e):n.bind(e)}function i(){return a?a.snapshot():function(e,...r){return e(...r)}}},1605:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"default",{enumerable:!0,get:function(){return a}});let n=t(2632)._(t(9757));function a(e,r){var t;let a={};"function"==typeof e&&(a.loader=e);let l={...a,...r};return(0,n.default)({...l,modules:null==(t=l.loadableGenerated)?void 0:t.modules})}("function"==typeof r.default||"object"==typeof r.default&&null!==r.default)&&void 0===r.default.__esModule&&(Object.defineProperty(r.default,"__esModule",{value:!0}),Object.assign(r.default,r),e.exports=r.default)},2963:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"workAsyncStorageInstance",{enumerable:!0,get:function(){return n}});let n=(0,t(473).createAsyncLocalStorage)()},3450:(e,r,t)=>{Promise.resolve().then(t.bind(t,6300))},5714:(e,r,t)=>{"use strict";function n(e){let{reason:r,children:t}=e;return t}Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"BailoutToCSR",{enumerable:!0,get:function(){return n}}),t(238)},6064:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"workAsyncStorage",{enumerable:!0,get:function(){return n.workAsyncStorageInstance}});let n=t(2963)},6300:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>f});var n=t(4248),a=t(4564),l=t(451),s=t(9661),i=t(9410),o=t(8440),u=t(8299),c=t(1605);let d=t.n(c)()(()=>t.e(648).then(t.bind(t,7899)).then(e=>e.QrReader),{loadableGenerated:{webpack:()=>[7899]},ssr:!1});function f(){let{userId:e}=(0,s.A)(),[r,t]=(0,a.useState)(!1),[c,f]=(0,a.useState)(""),[p,m]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{var e,r;let t=await (null==(r=navigator.mediaDevices)||null==(e=r.enumerateDevices)?void 0:e.call(r)),n=null==t?void 0:t.some(e=>"videoinput"===e.kind);m(null!=n&&n)}catch(e){m(!1)}})()},[]);let h=async r=>{let n;if(!e)return u.Ay.error("Inicia sesi\xf3n");try{if(!(n=JSON.parse(r)).shift||!n.fare)throw Error("Formato inv\xe1lido")}catch(e){return u.Ay.error("QR inv\xe1lido")}t(!0);try{var a;let r=null==(a=(await i.N.auth.getSession()).data.session)?void 0:a.access_token;if(!r)throw Error("Sin sesi\xf3n");let t=crypto.randomUUID(),l=await (0,o.Tx)("ride_pay",{passenger_id:e,shift:n.shift,fare:n.fare,idempotencyKey:t},r);u.Ay.success("Pago realizado: S/ ".concat(Number(l.tx.amount).toFixed(2))),f("")}catch(r){let e=(null==r?void 0:r.message)||"";e.includes("NO_VEHICLE_ASSIGNED")?u.Ay.error("Jornada sin veh\xedculo"):e.includes("SHIFT_CLOSED")?u.Ay.error("Jornada finalizada"):e.includes("FARE_NOT_FOUND")?u.Ay.error("Tarifa no v\xe1lida"):e.includes("INSUFFICIENT_FUNDS")?u.Ay.error("Saldo insuficiente"):u.Ay.error(e||"Error al pagar")}finally{t(!1)}},[v,y]=(0,a.useState)(0);return(0,n.jsx)(l.A,{role:"passenger",children:(0,n.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-5",children:[(0,n.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:["Apunta la c\xe1mara al QR del conductor. El QR contiene un JSON como: ",'{ "shift": "<uuid>", "fare": "troncal" }']}),p?(0,n.jsx)("div",{className:"overflow-hidden rounded-2xl border",children:(0,n.jsx)(d,{constraints:{facingMode:"environment"},onResult:(e,r)=>{e&&h(e.getText())}})}):!1===p?(0,n.jsx)("div",{className:"rounded-xl border p-4 text-sm text-amber-600",children:"No se detect\xf3 c\xe1mara (o el navegador no dio permiso). Usa la entrada manual m\xe1s abajo."}):(0,n.jsx)("div",{className:"text-sm text-gray-400",children:"Comprobando c\xe1mara…"})]}),(0,n.jsxs)("div",{className:"rounded-2xl border p-4 space-y-3",children:[(0,n.jsx)("div",{className:"text-sm text-gray-400",children:"\xbfNo puedes usar la c\xe1mara? Pega el contenido del QR:"}),(0,n.jsx)("textarea",{className:"w-full rounded-xl border px-3 py-2 min-h-[120px] bg-white dark:bg-gray-900",placeholder:'{"shift":"<uuid>","fare":"troncal"}',value:c,onChange:e=>f(e.target.value)}),(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)("button",{className:"btn",disabled:r,onClick:()=>h(c),children:r?"Procesando…":"Pagar con payload"}),(0,n.jsx)("button",{className:"btn-outline",onClick:()=>f(""),children:"Limpiar"})]})]})]})})}},8440:(e,r,t)=>{"use strict";t.d(r,{Tx:()=>a,c9:()=>l});var n=t(9410);async function a(e,r,t){let n="".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/").concat(e),a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},body:JSON.stringify(r)}),l=await a.json();if(!a.ok)throw Error((null==l?void 0:l.error)||"Function error");return l}async function l(e,r,t){var l;let s=null==(l=(await n.N.auth.getSession()).data.session)?void 0:l.access_token;if(!s)throw Error("No auth");return a("send_broadcast",{title:e,body:r,url:t},s)}},9167:(e,r,t)=>{"use strict";function n(e){let{moduleIds:r}=e;return null}Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"PreloadChunks",{enumerable:!0,get:function(){return n}}),t(4248),t(133),t(6064),t(1181)},9410:(e,r,t)=>{"use strict";t.d(r,{N:()=>n});let n=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,r,t)=>{"use strict";t.d(r,{A:()=>o,AuthProvider:()=>i});var n=t(4248),a=t(4564),l=t(9410);let s=(0,a.createContext)(null);function i(e){let{children:r}=e,[t,i]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[f,p]=(0,a.useState)(!0),m=async(e,r)=>{let{data:t}=await l.N.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return void d(t);let{data:n,error:a}=await l.N.rpc("ensure_profile",{p_id:e,p_email:null!=r?r:""});if(a){console.error("[ensure_profile rpc] error",a),d(null);return}d(null!=n?n:null)};(0,a.useEffect)(()=>{(async()=>{var e,r,t,n,a,s;let{data:o}=await l.N.auth.getSession(),c=null!=(a=null==(r=o.session)||null==(e=r.user)?void 0:e.id)?a:null,d=null!=(s=null==(n=o.session)||null==(t=n.user)?void 0:t.email)?s:null;i(c),u(d),c&&await m(c,d),p(!1)})();let{data:e}=l.N.auth.onAuthStateChange(async(e,r)=>{var t,n,a,l;let s=null!=(a=null==r||null==(t=r.user)?void 0:t.id)?a:null,o=null!=(l=null==r||null==(n=r.user)?void 0:n.email)?l:null;i(s),u(o),s?await m(s,o):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let h=async()=>{await l.N.auth.signOut()};return(0,n.jsx)(s.Provider,{value:{userId:t,email:o,profile:c,loading:f,signOut:h},children:r})}let o=()=>{let e=(0,a.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}},9757:(e,r,t)=>{"use strict";Object.defineProperty(r,"__esModule",{value:!0}),Object.defineProperty(r,"default",{enumerable:!0,get:function(){return o}});let n=t(4248),a=t(4564),l=t(5714);function s(e){return{default:e&&"default"in e?e.default:e}}t(9167);let i={loader:()=>Promise.resolve(s(()=>null)),loading:null,ssr:!0},o=function(e){let r={...i,...e},t=(0,a.lazy)(()=>r.loader().then(s)),o=r.loading;function u(e){let s=o?(0,n.jsx)(o,{isLoading:!0,pastDelay:!0,error:null}):null,i=!r.ssr||!!r.loading,u=i?a.Suspense:a.Fragment,c=r.ssr?(0,n.jsxs)(n.Fragment,{children:[null,(0,n.jsx)(t,{...e})]}):(0,n.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,n.jsx)(t,{...e})});return(0,n.jsx)(u,{...i?{fallback:s}:{},children:c})}return u.displayName="LoadableComponent",u}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);