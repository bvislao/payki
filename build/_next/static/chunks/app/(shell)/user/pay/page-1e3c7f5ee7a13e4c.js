(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,a,t)=>{"use strict";t.d(a,{A:()=>s});var r=t(4248),l=t(9661);function s(e){let{role:a,children:t}=e,{userId:s,profile:n,loading:i}=(0,l.A)();return i?(0,r.jsx)("div",{className:"card p-6",children:"Cargando…"}):s?n?"passenger"===a&&"passenger"!==n.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===a&&"driver"!==n.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===a&&"admin"!==n.role?(0,r.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,r.jsx)(r.Fragment,{children:t}):(0,r.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,r.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},3450:(e,a,t)=>{Promise.resolve().then(t.bind(t,3814))},3814:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>v});var r=t(4248),l=t(4564),s=t(451),n=t(9661),i=t(9410),c=t(8440),o=t(8299),u=t(7807);function d(e){let{onText:a,height:t=360}=e,[s,n]=(0,l.useState)(!1),[i,c]=(0,l.useState)([]),[o,d]=(0,l.useState)(void 0),[v,m]=(0,l.useState)("Pulsa “Activar c\xe1mara”"),h=(0,l.useRef)(null),p=(0,l.useRef)(null),x=(0,l.useRef)(null),f=(0,l.useRef)(0);(0,l.useEffect)(()=>{(async()=>{var e;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop())}catch(e){}let a=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);c(a);let t=a.find(e=>/back|rear|environment|trase/i.test(e.label));d(null==(e=null!=t?t:a[0])?void 0:e.deviceId)})().catch(()=>{})},[]);let y=()=>{var e,a,t;null==(e=x.current)||e.stop(),x.current=null,((null==(t=h.current)||null==(a=t.srcObject)?void 0:a.getTracks())||[]).forEach(e=>e.stop()),h.current&&(h.current.srcObject=null)};(0,l.useEffect)(()=>()=>y(),[]);let w=async()=>{if(h.current)try{n(!0),m("Iniciando c\xe1mara…"),y(),p.current||(p.current=new u.wg),x.current=await p.current.decodeFromVideoDevice(o,h.current,(e,t,r)=>{if(e){m("QR le\xeddo ✅");var l=e.getText();let t=Date.now();t-f.current<1200||(f.current=t,a(l))}}),m("C\xe1mara activa ✅")}catch(e){m("Error: ".concat((null==e?void 0:e.name)||(null==e?void 0:e.message)||e))}};return(0,r.jsxs)("div",{className:"w-full max-w-md mx-auto",children:[(0,r.jsxs)("div",{className:"grid gap-2 mb-3",children:[(0,r.jsxs)("label",{className:"text-sm",children:["C\xe1mara",(0,r.jsx)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:null!=o?o:"",onChange:e=>d(e.target.value||void 0),children:i.map(e=>(0,r.jsx)("option",{value:e.deviceId,children:e.label||"C\xe1mara ".concat(e.deviceId.slice(0,4),"…")},e.deviceId))})]}),(0,r.jsx)("button",{className:"btn",onClick:w,children:"Activar c\xe1mara"})]}),(0,r.jsxs)("div",{className:"relative w-full rounded-2xl border overflow-hidden bg-black/40",style:{height:t},children:[(0,r.jsx)("video",{ref:h,muted:!0,playsInline:!0,autoPlay:!0,style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),(0,r.jsx)("div",{className:"pointer-events-none absolute inset-0",children:(0,r.jsx)("div",{className:"absolute inset-8 border-2 border-white/70 rounded-xl"})})]}),(0,r.jsx)("div",{className:"text-xs mt-2 text-gray-500",children:v}),(0,r.jsxs)("ul",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[(0,r.jsx)("li",{children:"• iPhone/Safari/PWA: HTTPS o localhost y dar permisos de c\xe1mara."}),(0,r.jsx)("li",{children:"• Si queda negra, cambia de c\xe1mara en el selector y vuelve a “Activar c\xe1mara”."})]})]})}function v(){let{userId:e}=(0,n.A)(),[a,t]=(0,l.useState)(!1),[u,v]=(0,l.useState)(""),[m,h]=(0,l.useState)(null);(0,l.useEffect)(()=>{(async()=>{try{var e,a;let t=await (null==(a=navigator.mediaDevices)||null==(e=a.enumerateDevices)?void 0:e.call(a)),r=null==t?void 0:t.some(e=>"videoinput"===e.kind);h(null!=r&&r)}catch(e){h(!1)}})()},[]);let p=async a=>{var t,r,l,s,n;let u,d;try{if(a.startsWith("http")||a.startsWith("payki://")){let e=new URL(a.replace("payki://","https://payki.local/"));u=e.searchParams.get("shift")||void 0,d=e.searchParams.get("fare")||void 0}else{let e=JSON.parse(a);u=e.shift,d=e.fare}}catch(e){o.Ay.error("QR inv\xe1lido");return}if(!u||!d)return void o.Ay.error("QR incompleto");if(!e)return void o.Ay.error("Inicia sesi\xf3n");try{let a=null==(t=(await i.N.auth.getSession()).data.session)?void 0:t.access_token,n=crypto.randomUUID(),v=await (0,c.Tx)("ride_pay",{passenger_id:e,shift:u,fare:d,idempotencyKey:n},a),m=null!=(r=null==v?void 0:v.tx)?r:null,h=null!=(s=null!=(l=null==m?void 0:m.amount)?l:null==m?void 0:m.tx_amount)?s:null;if(!(null==v?void 0:v.ok)||Number.isNaN(h))throw Error("Transacci\xf3n inv\xe1lida");o.Ay.success("Pago realizado: S/ ".concat(h.toFixed(2)))}catch(e){o.Ay.error(null!=(n=null==e?void 0:e.message)?n:"Error al pagar")}};return(0,r.jsx)(s.A,{role:"passenger",children:(0,r.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-4",children:[(0,r.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,r.jsx)(d,{onText:p,height:360}),(0,r.jsx)("button",{className:"btn w-full mt-3",disabled:a,children:a?"Procesando…":"Listo"})]})})}},8440:(e,a,t)=>{"use strict";t.d(a,{Tx:()=>l,c9:()=>s});var r=t(9410);async function l(e,a,t){let r="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),l=await fetch("".concat(r,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer ".concat(t)}:{}},body:JSON.stringify(a)}),s=await l.text(),n=null;try{n=s?JSON.parse(s):null}catch(e){}if(!l.ok)throw Error(n&&n.error?n.error:s||l.statusText);return n}async function s(e,a,t){var s;let n=null==(s=(await r.N.auth.getSession()).data.session)?void 0:s.access_token;if(!n)throw Error("No auth");return l("send_broadcast",{title:e,body:a,url:t},n)}},9410:(e,a,t)=>{"use strict";t.d(a,{N:()=>r});let r=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,t)=>{"use strict";t.d(a,{A:()=>c,AuthProvider:()=>i});var r=t(4248),l=t(4564),s=t(9410);let n=(0,l.createContext)(null);function i(e){let{children:a}=e,[t,i]=(0,l.useState)(null),[c,o]=(0,l.useState)(null),[u,d]=(0,l.useState)(null),[v,m]=(0,l.useState)(!0),h=async(e,a)=>{let{data:t}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return void d(t);let{data:r,error:l}=await s.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(l){console.error("[ensure_profile rpc] error",l),d(null);return}d(null!=r?r:null)};(0,l.useEffect)(()=>{(async()=>{var e,a,t,r,l,n;let{data:c}=await s.N.auth.getSession(),u=null!=(l=null==(a=c.session)||null==(e=a.user)?void 0:e.id)?l:null,d=null!=(n=null==(r=c.session)||null==(t=r.user)?void 0:t.email)?n:null;i(u),o(d),u&&await h(u,d),m(!1)})();let{data:e}=s.N.auth.onAuthStateChange(async(e,a)=>{var t,r,l,s;let n=null!=(l=null==a||null==(t=a.user)?void 0:t.id)?l:null,c=null!=(s=null==a||null==(r=a.user)?void 0:r.email)?s:null;i(n),o(c),n?await h(n,c):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let p=async()=>{await s.N.auth.signOut()};return(0,r.jsx)(n.Provider,{value:{userId:t,email:c,profile:u,loading:v,signOut:p},children:a})}let c=()=>{let e=(0,l.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,807,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);