(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,a,t)=>{"use strict";t.d(a,{A:()=>u});var l=t(4248),r=t(7642),s=t.n(r),n=t(9661),i=t(8650),c=t(5523);function u(e){let{role:a,children:t}=e,{loading:r,error:u,userId:o,profile:d}=(0,n.A)();return r?(0,l.jsx)("div",{className:"min-h-[50vh] flex items-center justify-center",children:(0,l.jsx)(i.A,{className:"h-6 w-6 animate-spin"})}):u?(0,l.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,l.jsxs)("div",{className:"text-sm text-red-600",children:["Error: ",u]}),(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Refresca e int\xe9ntalo nuevamente."})]}):o?(null==d?void 0:d.role)!==a?(0,l.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,l.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,l.jsxs)("div",{className:"text-sm",children:["Acceso restringido. Requiere rol ",(0,l.jsx)("b",{children:a}),"."]})]}):(0,l.jsx)(l.Fragment,{children:t}):(0,l.jsxs)("div",{className:"card p-6 text-center space-y-3",children:[(0,l.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,l.jsx)("div",{className:"text-sm",children:"Necesitas iniciar sesi\xf3n para acceder."}),(0,l.jsx)(s(),{className:"btn",href:"/login",children:"Ir a Login"})]})}},3450:(e,a,t)=>{Promise.resolve().then(t.bind(t,3814))},3814:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>v});var l=t(4248),r=t(4564),s=t(451),n=t(9661),i=t(9410),c=t(8440),u=t(8299),o=t(7807);function d(e){let{onText:a,height:t=360}=e,[s,n]=(0,r.useState)(!1),[i,c]=(0,r.useState)([]),[u,d]=(0,r.useState)(void 0),[m,v]=(0,r.useState)("Pulsa “Activar c\xe1mara”"),h=(0,r.useRef)(null),x=(0,r.useRef)(null),p=(0,r.useRef)(null),f=(0,r.useRef)(0);(0,r.useEffect)(()=>{(async()=>{var e;try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop())}catch(e){}let a=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);c(a);let t=a.find(e=>/back|rear|environment|trase/i.test(e.label));d(null==(e=null!=t?t:a[0])?void 0:e.deviceId)})().catch(()=>{})},[]);let y=()=>{var e,a,t;null==(e=p.current)||e.stop(),p.current=null,((null==(t=h.current)||null==(a=t.srcObject)?void 0:a.getTracks())||[]).forEach(e=>e.stop()),h.current&&(h.current.srcObject=null)};(0,r.useEffect)(()=>()=>y(),[]);let N=async()=>{if(h.current)try{n(!0),v("Iniciando c\xe1mara…"),y(),x.current||(x.current=new o.wg),p.current=await x.current.decodeFromVideoDevice(u,h.current,(e,t,l)=>{if(e){v("QR le\xeddo ✅");var r=e.getText();let t=Date.now();t-f.current<1200||(f.current=t,a(r))}}),v("C\xe1mara activa ✅")}catch(e){v("Error: ".concat((null==e?void 0:e.name)||(null==e?void 0:e.message)||e))}};return(0,l.jsxs)("div",{className:"w-full max-w-md mx-auto",children:[(0,l.jsxs)("div",{className:"grid gap-2 mb-3",children:[(0,l.jsxs)("label",{className:"text-sm",children:["C\xe1mara",(0,l.jsx)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:null!=u?u:"",onChange:e=>d(e.target.value||void 0),children:i.map(e=>(0,l.jsx)("option",{value:e.deviceId,children:e.label||"C\xe1mara ".concat(e.deviceId.slice(0,4),"…")},e.deviceId))})]}),(0,l.jsx)("button",{className:"btn",onClick:N,children:"Activar c\xe1mara"})]}),(0,l.jsxs)("div",{className:"relative w-full rounded-2xl border overflow-hidden bg-black/40",style:{height:t},children:[(0,l.jsx)("video",{ref:h,muted:!0,playsInline:!0,autoPlay:!0,style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),(0,l.jsx)("div",{className:"pointer-events-none absolute inset-0",children:(0,l.jsx)("div",{className:"absolute inset-8 border-2 border-white/70 rounded-xl"})})]}),(0,l.jsx)("div",{className:"text-xs mt-2 text-gray-500",children:m}),(0,l.jsxs)("ul",{className:"mt-2 text-xs text-gray-500 space-y-1",children:[(0,l.jsx)("li",{children:"• iPhone/Safari/PWA: HTTPS o localhost y dar permisos de c\xe1mara."}),(0,l.jsx)("li",{children:"• Si queda negra, cambia de c\xe1mara en el selector y vuelve a “Activar c\xe1mara”."})]})]})}var m=t(5519);function v(){let e=(0,m.useRouter)(),{userId:a}=(0,n.A)(),[t,o]=(0,r.useState)(!1),[v,h]=(0,r.useState)(""),[x,p]=(0,r.useState)(null);(0,r.useEffect)(()=>{(async()=>{try{var e,a;let t=await (null==(a=navigator.mediaDevices)||null==(e=a.enumerateDevices)?void 0:e.call(a)),l=null==t?void 0:t.some(e=>"videoinput"===e.kind);p(null!=l&&l)}catch(e){p(!1)}})()},[]);let f=async t=>{var l,r,s,n,o;let d,m;try{if(t.startsWith("http")||t.startsWith("payki://")){let e=new URL(t.replace("payki://","https://payki.local/"));d=e.searchParams.get("shift")||void 0,m=e.searchParams.get("fare")||void 0}else{let e=JSON.parse(t);d=e.shift,m=e.fare}}catch(e){u.Ay.error("QR inv\xe1lido");return}if(!d||!m)return void u.Ay.error("QR incompleto");if(!a)return void u.Ay.error("Inicia sesi\xf3n");try{let t=null==(l=(await i.N.auth.getSession()).data.session)?void 0:l.access_token,o=crypto.randomUUID(),v=await (0,c.Tx)("ride_pay",{passenger_id:a,shift:d,fare:m,idempotencyKey:o},t),h=null!=(r=null==v?void 0:v.tx)?r:null,x=null!=(n=null!=(s=null==h?void 0:h.amount)?s:null==h?void 0:h.tx_amount)?n:null;if(!(null==v?void 0:v.ok)||Number.isNaN(x))throw Error("Transacci\xf3n inv\xe1lida");u.Ay.success("Pago realizado: S/ ".concat(x.toFixed(2))),e.push("/user")}catch(e){u.Ay.error(null!=(o=null==e?void 0:e.message)?o:"Error al pagar")}};return(0,l.jsx)(s.A,{role:"passenger",children:(0,l.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-4",children:[(0,l.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,l.jsx)(d,{onText:f,height:360}),(0,l.jsx)("button",{className:"btn w-full mt-3",disabled:t,children:t?"Procesando…":"Listo"})]})})}},8440:(e,a,t)=>{"use strict";t.d(a,{Tx:()=>r,c9:()=>s});var l=t(9410);async function r(e,a,t){let l="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),r=await fetch("".concat(l,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer ".concat(t)}:{}},body:JSON.stringify(a)}),s=await r.text(),n=null;try{n=s?JSON.parse(s):null}catch(e){}if(!r.ok)throw Error(n&&n.error?n.error:s||r.statusText);return n}async function s(e,a,t){var s;let n=null==(s=(await l.N.auth.getSession()).data.session)?void 0:s.access_token;if(!n)throw Error("No auth");return r("send_broadcast",{title:e,body:a,url:t},n)}},9410:(e,a,t)=>{"use strict";t.d(a,{N:()=>l});let l=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,t)=>{"use strict";t.d(a,{A:()=>c,O:()=>i});var l=t(4248),r=t(4564),s=t(9410);let n=(0,r.createContext)(null);function i(e){let{children:a}=e,[t,i]=(0,r.useState)(null),[c,u]=(0,r.useState)(null),[o,d]=(0,r.useState)(null),[m,v]=(0,r.useState)(!0),[h,x]=(0,r.useState)(null),p=(0,r.useCallback)(async(e,a)=>{v(!0),x(null);try{var t;let{data:l,error:r}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();if(r&&"PGRST116"!==r.code&&console.warn("[profiles select]",r),l)return void d(l);let{data:n,error:i}=await s.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(i)throw console.error("[ensure_profile]",i),Error("No se pudo crear/obtener el perfil");let{data:c,error:u}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();u&&console.warn("[profiles reselect]",u),d(null!=(t=null!=c?c:n)?t:null)}catch(e){d(null),x((null==e?void 0:e.message)||"Error de autenticaci\xf3n")}finally{v(!1)}},[]),f=(0,r.useCallback)(async()=>{var e,a;if(!t)return;let{data:{session:l}}=await s.N.auth.getSession();await p(t,null!=(a=null==l||null==(e=l.user)?void 0:e.email)?a:null)},[t,p]);(0,r.useEffect)(()=>{(async()=>{try{var e,a,t,l;v(!0);let{data:{session:r}}=await s.N.auth.getSession(),n=null!=(t=null==r||null==(e=r.user)?void 0:e.id)?t:null,c=null!=(l=null==r||null==(a=r.user)?void 0:a.email)?l:null;i(n),u(c),n?await p(n,c):v(!1)}catch(e){x((null==e?void 0:e.message)||"Error inicializando sesi\xf3n"),v(!1)}})();let{data:e}=s.N.auth.onAuthStateChange(async(e,a)=>{var t,l,r,s;let n=null!=(r=null==a||null==(t=a.user)?void 0:t.id)?r:null,c=null!=(s=null==a||null==(l=a.user)?void 0:l.email)?s:null;i(n),u(c),n?await p(n,c):(d(null),v(!1))});return()=>{e.subscription.unsubscribe()}},[p]);let y=async()=>{await s.N.auth.signOut(),i(null),u(null),d(null)};return(0,l.jsx)(n.Provider,{value:{userId:t,email:c,profile:o,loading:m,error:h,refreshProfile:f,signOut:y},children:a})}let c=()=>{let e=(0,r.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,642,299,196,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);