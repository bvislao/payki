(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var n=r(4248),a=r(9661);function l(e){let{role:t,children:r}=e,{userId:l,profile:s,loading:i}=(0,a.A)();return i?(0,n.jsx)("div",{className:"card p-6",children:"Cargando…"}):l?s?"passenger"===t&&"passenger"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===t&&"driver"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===t&&"admin"!==s.role?(0,n.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,n.jsx)(n.Fragment,{children:r}):(0,n.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,n.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},473:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{bindSnapshot:function(){return s},createAsyncLocalStorage:function(){return l},createSnapshot:function(){return i}});let r=Object.defineProperty(Error("Invariant: AsyncLocalStorage accessed in runtime where it is not available"),"__NEXT_ERROR_CODE",{value:"E504",enumerable:!1,configurable:!0});class n{disable(){throw r}getStore(){}run(){throw r}exit(){throw r}enterWith(){throw r}static bind(e){return e}}let a="undefined"!=typeof globalThis&&globalThis.AsyncLocalStorage;function l(){return a?new a:new n}function s(e){return a?a.bind(e):n.bind(e)}function i(){return a?a.snapshot():function(e,...t){return e(...t)}}},1605:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return a}});let n=r(2632)._(r(9757));function a(e,t){var r;let a={};"function"==typeof e&&(a.loader=e);let l={...a,...t};return(0,n.default)({...l,modules:null==(r=l.loadableGenerated)?void 0:r.modules})}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},2963:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorageInstance",{enumerable:!0,get:function(){return n}});let n=(0,r(473).createAsyncLocalStorage)()},3450:(e,t,r)=>{Promise.resolve().then(r.bind(r,6300))},5714:(e,t,r)=>{"use strict";function n(e){let{reason:t,children:r}=e;return r}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return n}}),r(238)},6064:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"workAsyncStorage",{enumerable:!0,get:function(){return n.workAsyncStorageInstance}});let n=r(2963)},6300:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>f});var n=r(4248),a=r(4564),l=r(451),s=r(9661),i=r(9410),o=r(8440),u=r(8299),c=r(1605);let d=r.n(c)()(()=>r.e(648).then(r.bind(r,7899)).then(e=>e.QrReader),{loadableGenerated:{webpack:()=>[7899]},ssr:!1});function f(){let{userId:e}=(0,s.A)(),[t,r]=(0,a.useState)(!1),[c,f]=(0,a.useState)(""),[p,m]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{var e,t;let r=await (null==(t=navigator.mediaDevices)||null==(e=t.enumerateDevices)?void 0:e.call(t)),n=null==r?void 0:r.some(e=>"videoinput"===e.kind);m(null!=n&&n)}catch(e){m(!1)}})()},[]);let h=async t=>{let n;if(!e)return u.Ay.error("Inicia sesi\xf3n");try{if(!(n=JSON.parse(t)).shift||!n.fare)throw Error("Formato inv\xe1lido")}catch(e){return u.Ay.error("QR inv\xe1lido")}r(!0);try{var a;let t=null==(a=(await i.N.auth.getSession()).data.session)?void 0:a.access_token;if(!t)throw Error("Sin sesi\xf3n");let r=await (0,o.Tx)("ride_pay",{shift:n.shift,fare:n.fare,passenger_id:e},t);u.Ay.success("Pago realizado: S/ ".concat(Number(r.tx.amount).toFixed(2))),f("")}catch(t){let e=(null==t?void 0:t.message)||"";e.includes("NO_VEHICLE_ASSIGNED")?u.Ay.error("Jornada sin veh\xedculo"):e.includes("SHIFT_CLOSED")?u.Ay.error("Jornada finalizada"):e.includes("FARE_NOT_FOUND")?u.Ay.error("Tarifa no v\xe1lida"):u.Ay.error(e||"Error al pagar")}finally{r(!1)}},[v,b]=(0,a.useState)(0);return(0,n.jsx)(l.A,{role:"passenger",children:(0,n.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-5",children:[(0,n.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,n.jsxs)("div",{className:"space-y-3",children:[(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:["Apunta la c\xe1mara al QR del conductor. El QR contiene un JSON como: ",'{ "shift": "<uuid>", "fare": "troncal" }']}),p?(0,n.jsx)("div",{className:"overflow-hidden rounded-2xl border",children:(0,n.jsx)(d,{constraints:{facingMode:"environment"},onResult:(e,t)=>{e&&h(e.getText())}})}):!1===p?(0,n.jsx)("div",{className:"rounded-xl border p-4 text-sm text-amber-600",children:"No se detect\xf3 c\xe1mara (o el navegador no dio permiso). Usa la entrada manual m\xe1s abajo."}):(0,n.jsx)("div",{className:"text-sm text-gray-400",children:"Comprobando c\xe1mara…"})]}),(0,n.jsxs)("div",{className:"rounded-2xl border p-4 space-y-3",children:[(0,n.jsx)("div",{className:"text-sm text-gray-400",children:"\xbfNo puedes usar la c\xe1mara? Pega el contenido del QR:"}),(0,n.jsx)("textarea",{className:"w-full rounded-xl border px-3 py-2 min-h-[120px] bg-white dark:bg-gray-900",placeholder:'{"shift":"<uuid>","fare":"troncal"}',value:c,onChange:e=>f(e.target.value)}),(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)("button",{className:"btn",disabled:t,onClick:()=>h(c),children:t?"Procesando…":"Pagar con payload"}),(0,n.jsx)("button",{className:"btn-outline",onClick:()=>f(""),children:"Limpiar"})]})]})]})})}},8440:(e,t,r)=>{"use strict";r.d(t,{Tx:()=>a,c9:()=>l});var n=r(9410);async function a(e,t,r){let n="".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/").concat(e),a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)},body:JSON.stringify(t)}),l=await a.json();if(!a.ok)throw Error((null==l?void 0:l.error)||"Function error");return l}async function l(e,t,r){var l;let s=null==(l=(await n.N.auth.getSession()).data.session)?void 0:l.access_token;if(!s)throw Error("No auth");return a("send_broadcast",{title:e,body:t,url:r},s)}},9167:(e,t,r)=>{"use strict";function n(e){let{moduleIds:t}=e;return null}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadChunks",{enumerable:!0,get:function(){return n}}),r(4248),r(133),r(6064),r(1181)},9410:(e,t,r)=>{"use strict";r.d(t,{N:()=>n});let n=(0,r(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,r)=>{"use strict";r.d(t,{A:()=>o,AuthProvider:()=>i});var n=r(4248),a=r(4564),l=r(9410);let s=(0,a.createContext)(null);function i(e){let{children:t}=e,[r,i]=(0,a.useState)(null),[o,u]=(0,a.useState)(null),[c,d]=(0,a.useState)(null),[f,p]=(0,a.useState)(!0),m=async(e,t)=>{let{data:r}=await l.N.from("profiles").select("*").eq("id",e).maybeSingle();if(r)return void d(r);let{data:n,error:a}=await l.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(a){console.error("[ensure_profile rpc] error",a),d(null);return}d(null!=n?n:null)};(0,a.useEffect)(()=>{(async()=>{var e,t,r,n,a,s;let{data:o}=await l.N.auth.getSession(),c=null!=(a=null==(t=o.session)||null==(e=t.user)?void 0:e.id)?a:null,d=null!=(s=null==(n=o.session)||null==(r=n.user)?void 0:r.email)?s:null;i(c),u(d),c&&await m(c,d),p(!1)})();let{data:e}=l.N.auth.onAuthStateChange(async(e,t)=>{var r,n,a,l;let s=null!=(a=null==t||null==(r=t.user)?void 0:r.id)?a:null,o=null!=(l=null==t||null==(n=t.user)?void 0:n.email)?l:null;i(s),u(o),s?await m(s,o):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let h=async()=>{await l.N.auth.signOut()};return(0,n.jsx)(s.Provider,{value:{userId:r,email:o,profile:c,loading:f,signOut:h},children:t})}let o=()=>{let e=(0,a.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}},9757:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o}});let n=r(4248),a=r(4564),l=r(5714);function s(e){return{default:e&&"default"in e?e.default:e}}r(9167);let i={loader:()=>Promise.resolve(s(()=>null)),loading:null,ssr:!0},o=function(e){let t={...i,...e},r=(0,a.lazy)(()=>t.loader().then(s)),o=t.loading;function u(e){let s=o?(0,n.jsx)(o,{isLoading:!0,pastDelay:!0,error:null}):null,i=!t.ssr||!!t.loading,u=i?a.Suspense:a.Fragment,c=t.ssr?(0,n.jsxs)(n.Fragment,{children:[null,(0,n.jsx)(r,{...e})]}):(0,n.jsx)(l.BailoutToCSR,{reason:"next/dynamic",children:(0,n.jsx)(r,{...e})});return(0,n.jsx)(u,{...i?{fallback:s}:{},children:c})}return u.displayName="LoadableComponent",u}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);