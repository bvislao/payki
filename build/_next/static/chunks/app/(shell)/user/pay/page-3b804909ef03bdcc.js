(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[351],{451:(e,a,r)=>{"use strict";r.d(a,{A:()=>n});var s=r(4248),l=r(9661);function n(e){let{role:a,children:r}=e,{userId:n,profile:t,loading:i}=(0,l.A)();return i?(0,s.jsx)("div",{className:"card p-6",children:"Cargando…"}):n?t?"passenger"===a&&"passenger"!==t.role?(0,s.jsx)("div",{className:"card p-6",children:"Solo para pasajeros."}):"driver"===a&&"driver"!==t.role?(0,s.jsx)("div",{className:"card p-6",children:"Solo para conductores."}):"admin"===a&&"admin"!==t.role?(0,s.jsx)("div",{className:"card p-6",children:"Solo admins."}):(0,s.jsx)(s.Fragment,{children:r}):(0,s.jsx)("div",{className:"card p-6",children:"Perfil no encontrado."}):(0,s.jsx)("div",{className:"card p-6",children:"Inicia sesi\xf3n."})}},3450:(e,a,r)=>{Promise.resolve().then(r.bind(r,7023))},7023:(e,a,r)=>{"use strict";r.r(a),r.d(a,{default:()=>u});var s=r(4248),l=r(4564),n=r(451),t=r(9661),i=r(9410),o=r(8440),c=r(8299);function u(){let{userId:e}=(0,t.A)(),[a,r]=(0,l.useState)('{"shift":"<uuid>","fare":"troncal"}'),[u,d]=(0,l.useState)(!1),h=async()=>{let s;if(!e)return c.Ay.error("Inicia sesi\xf3n");try{if(!(s=JSON.parse(a)).shift||!s.fare)throw Error("Formato inv\xe1lido")}catch(e){return c.Ay.error("Pegue un JSON v\xe1lido del QR")}d(!0);try{var l;let a=null==(l=(await i.N.auth.getSession()).data.session)?void 0:l.access_token;if(!a)throw Error("Sin sesi\xf3n");let n=await (0,o.Tx)("ride_pay",{shift:s.shift,fare:s.fare,passenger_id:e},a);c.Ay.success("Pago realizado: S/ ".concat(Number(n.tx.amount).toFixed(2))),r("")}catch(a){let e=(null==a?void 0:a.message)||"";e.includes("NO_VEHICLE_ASSIGNED")?c.Ay.error("Jornada sin veh\xedculo"):e.includes("SHIFT_CLOSED")?c.Ay.error("Jornada finalizada"):e.includes("FARE_NOT_FOUND")?c.Ay.error("Tarifa no v\xe1lida"):c.Ay.error(e||"Error al pagar")}finally{d(!1)}};return(0,s.jsx)(n.A,{role:"passenger",children:(0,s.jsxs)("div",{className:"max-w-2xl mx-auto card p-6 space-y-4",children:[(0,s.jsx)("h2",{className:"text-2xl font-semibold",children:"Pagar Pasaje (QR)"}),(0,s.jsxs)("div",{className:"rounded-2xl border p-4",children:[(0,s.jsx)("div",{className:"text-sm text-gray-400 mb-2",children:"Simula la c\xe1mara pegando el contenido del QR:"}),(0,s.jsx)("textarea",{className:"w-full rounded-xl border px-3 py-2 min-h-[140px] bg-white dark:bg-gray-900",placeholder:'{"shift":"<uuid>","fare":"troncal"}',value:a,onChange:e=>r(e.target.value)}),(0,s.jsxs)("div",{className:"flex gap-3 mt-4",children:[(0,s.jsx)("button",{className:"btn",disabled:u,onClick:h,children:u?"Procesando…":"Simular Escaneo Exitoso"}),(0,s.jsx)("button",{className:"btn-outline",onClick:()=>r(""),children:"Limpiar"})]})]})]})})}},8440:(e,a,r)=>{"use strict";r.d(a,{Tx:()=>l,c9:()=>n});var s=r(9410);async function l(e,a,r){let s="".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/").concat(e),l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)},body:JSON.stringify(a)}),n=await l.json();if(!l.ok)throw Error((null==n?void 0:n.error)||"Function error");return n}async function n(e,a,r){var n;let t=null==(n=(await s.N.auth.getSession()).data.session)?void 0:n.access_token;if(!t)throw Error("No auth");return l("send_broadcast",{title:e,body:a,url:r},t)}},9410:(e,a,r)=>{"use strict";r.d(a,{N:()=>s});let s=(0,r(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,r)=>{"use strict";r.d(a,{A:()=>o,AuthProvider:()=>i});var s=r(4248),l=r(4564),n=r(9410);let t=(0,l.createContext)(null);function i(e){let{children:a}=e,[r,i]=(0,l.useState)(null),[o,c]=(0,l.useState)(null),[u,d]=(0,l.useState)(null),[h,m]=(0,l.useState)(!0),p=async(e,a)=>{let{data:r}=await n.N.from("profiles").select("*").eq("id",e).maybeSingle();if(r)return void d(r);let{data:s,error:l}=await n.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(l){console.error("[ensure_profile rpc] error",l),d(null);return}d(null!=s?s:null)};(0,l.useEffect)(()=>{(async()=>{var e,a,r,s,l,t;let{data:o}=await n.N.auth.getSession(),u=null!=(l=null==(a=o.session)||null==(e=a.user)?void 0:e.id)?l:null,d=null!=(t=null==(s=o.session)||null==(r=s.user)?void 0:r.email)?t:null;i(u),c(d),u&&await p(u,d),m(!1)})();let{data:e}=n.N.auth.onAuthStateChange(async(e,a)=>{var r,s,l,n;let t=null!=(l=null==a||null==(r=a.user)?void 0:r.id)?l:null,o=null!=(n=null==a||null==(s=a.user)?void 0:s.email)?n:null;i(t),c(o),t?await p(t,o):d(null)});return()=>{e.subscription.unsubscribe()}},[]);let f=async()=>{await n.N.auth.signOut()};return(0,s.jsx)(t.Provider,{value:{userId:r,email:o,profile:u,loading:h,signOut:f},children:a})}let o=()=>{let e=(0,l.useContext)(t);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=3450)),_N_E=e.O()}]);