(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[422],{451:(e,t,a)=>{"use strict";a.d(t,{A:()=>o});var r=a(4248),l=a(7642),s=a.n(l),n=a(9661),i=a(8650),c=a(5523);function o(e){let{role:t,children:a}=e,{loading:l,error:o,userId:u,profile:d}=(0,n.A)();return l?(0,r.jsx)("div",{className:"min-h-[50vh] flex items-center justify-center",children:(0,r.jsx)(i.A,{className:"h-6 w-6 animate-spin"})}):o?(0,r.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,r.jsxs)("div",{className:"text-sm text-red-600",children:["Error: ",o]}),(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Refresca e int\xe9ntalo nuevamente."})]}):u?(null==d?void 0:d.role)!==t?(0,r.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,r.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,r.jsxs)("div",{className:"text-sm",children:["Acceso restringido. Requiere rol ",(0,r.jsx)("b",{children:t}),"."]})]}):(0,r.jsx)(r.Fragment,{children:a}):(0,r.jsxs)("div",{className:"card p-6 text-center space-y-3",children:[(0,r.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,r.jsx)("div",{className:"text-sm",children:"Necesitas iniciar sesi\xf3n para acceder."}),(0,r.jsx)(s(),{className:"btn",href:"/login",children:"Ir a Login"})]})}},1046:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>m});var r=a(4248),l=a(4564),s=a(451),n=a(7642),i=a.n(n),c=a(9661),o=a(9410);let u=new Intl.DateTimeFormat("es-PE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1});async function d(e){let{data:t}=await o.N.from("profiles").select("balance").eq("id",e).maybeSingle(),{data:a}=await o.N.from("transactions").select("id,type,amount,ts,meta").eq("passenger_id",e).in("type",["ride","topup"]).order("ts",{ascending:!1}).limit(15),r=(a||[]).map(e=>{var t,a,r,l;let s=u.format(new Date(e.ts)).replace(",",""),n=((r=null==(t=e.meta)?void 0:t.fare_code)?null!=(l=({troncal:"Troncal",integrada:"Integrada",interburano:"Interburbano",interurbano:"Interburbano",urbano:"Urbano",zonal:"Zonal",general:"General",universitario:"Universitario",escolar:"Escolar"})[String(r).toLowerCase()])?l:String(r):null)||(null==(a=e.meta)?void 0:a.fare_label)||"Pasaje",i="ride"===e.type?"Viaje - ".concat(n," - ").concat(s):"Recarga - Tarjeta - ".concat(s);return{id:e.id,type:e.type,label:i,amount:Number(e.amount),date:e.ts}});return{balance:Number((null==t?void 0:t.balance)||0),recent:r}}function m(){let{userId:e,email:t,profile:a}=(0,c.A)(),[n,o]=(0,l.useState)(0),[u,m]=(0,l.useState)([]),[h,x]=(0,l.useState)(!0);return(0,l.useEffect)(()=>{let t=!0;return(async()=>{if(!e)return x(!1);let a=await d(e);t&&(o(a.balance),m(a.recent),x(!1))})(),()=>{t=!1}},[e]),(0,r.jsx)(s.A,{role:"passenger",children:(0,r.jsxs)("div",{className:"grid gap-6 md:grid-cols-2",children:[(0,r.jsxs)("div",{className:"card p-6 space-y-3",children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold",children:["Hola ",t]}),(0,r.jsxs)("div",{className:"text-sm text-gray-500",children:["Rol: ",(0,r.jsx)("b",{children:null==a?void 0:a.role})]}),(0,r.jsxs)("div",{className:"text-2xl font-bold",children:["Saldo: S/ ",n.toFixed(2)]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,r.jsx)(i(),{className:"btn w-full",href:"/user/pay",children:"Pagar Pasaje (QR)"}),(0,r.jsx)(i(),{className:"btn-outline w-full",href:"/user/recharge",children:"Recargar Saldo"})]})]}),(0,r.jsxs)("div",{className:"card p-6",children:[(0,r.jsx)("h3",{className:"font-semibold mb-3",children:"Actividad reciente (\xfaltimos 15)"}),h?(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"Cargandoâ€¦"}):0===u.length?(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"Sin movimientos."}):(0,r.jsx)("ul",{className:"space-y-2 text-sm",children:u.map(e=>(0,r.jsxs)("li",{className:"flex items-center justify-between",children:[(0,r.jsx)("span",{className:"truncate pr-3",children:e.label}),(0,r.jsxs)("span",{className:"topup"===e.type?"text-green-600":"text-red-600",children:["topup"===e.type?"+":"-","S/ ",e.amount.toFixed(2)]})]},e.id))})]}),(0,r.jsx)(i(),{className:"btn-outline",href:"/user/nearby",children:"Ver unidades cercanas"})]})})}},4091:(e,t,a)=>{Promise.resolve().then(a.bind(a,1046))},5112:(e,t,a)=>{"use strict";a.d(t,{A:()=>c});var r=a(4564);let l=e=>{let t=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,a)=>a?a.toUpperCase():t.toLowerCase());return t.charAt(0).toUpperCase()+t.slice(1)},s=function(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return t.filter((e,t,a)=>!!e&&""!==e.trim()&&a.indexOf(e)===t).join(" ").trim()};var n={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let i=(0,r.forwardRef)((e,t)=>{let{color:a="currentColor",size:l=24,strokeWidth:i=2,absoluteStrokeWidth:c,className:o="",children:u,iconNode:d,...m}=e;return(0,r.createElement)("svg",{ref:t,...n,width:l,height:l,stroke:a,strokeWidth:c?24*Number(i)/Number(l):i,className:s("lucide",o),...!u&&!(e=>{for(let t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0})(m)&&{"aria-hidden":"true"},...m},[...d.map(e=>{let[t,a]=e;return(0,r.createElement)(t,a)}),...Array.isArray(u)?u:[u]])}),c=(e,t)=>{let a=(0,r.forwardRef)((a,n)=>{let{className:c,...o}=a;return(0,r.createElement)(i,{ref:n,iconNode:t,className:s("lucide-".concat(l(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),"lucide-".concat(e),c),...o})});return a.displayName=l(e),a}},5523:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(5112).A)("lock-keyhole",[["circle",{cx:"12",cy:"16",r:"1",key:"1au0dj"}],["rect",{x:"3",y:"10",width:"18",height:"12",rx:"2",key:"6s8ecr"}],["path",{d:"M7 10V7a5 5 0 0 1 10 0v3",key:"1pqi11"}]])},8650:(e,t,a)=>{"use strict";a.d(t,{A:()=>r});let r=(0,a(5112).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},9410:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,t,a)=>{"use strict";a.d(t,{A:()=>c,O:()=>i});var r=a(4248),l=a(4564),s=a(9410);let n=(0,l.createContext)(null);function i(e){let{children:t}=e,[a,i]=(0,l.useState)(null),[c,o]=(0,l.useState)(null),[u,d]=(0,l.useState)(null),[m,h]=(0,l.useState)(!0),[x,p]=(0,l.useState)(null),f=(0,l.useCallback)(async(e,t)=>{h(!0),p(null);try{var a;let{data:r,error:l}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();if(l&&"PGRST116"!==l.code&&console.warn("[profiles select]",l),r)return void d(r);let{data:n,error:i}=await s.N.rpc("ensure_profile",{p_id:e,p_email:null!=t?t:""});if(i)throw console.error("[ensure_profile]",i),Error("No se pudo crear/obtener el perfil");let{data:c,error:o}=await s.N.from("profiles").select("*").eq("id",e).maybeSingle();o&&console.warn("[profiles reselect]",o),d(null!=(a=null!=c?c:n)?a:null)}catch(e){d(null),p((null==e?void 0:e.message)||"Error de autenticaci\xf3n")}finally{h(!1)}},[]),v=(0,l.useCallback)(async()=>{var e,t;if(!a)return;let{data:{session:r}}=await s.N.auth.getSession();await f(a,null!=(t=null==r||null==(e=r.user)?void 0:e.email)?t:null)},[a,f]);(0,l.useEffect)(()=>{(async()=>{try{var e,t,a,r;h(!0);let{data:{session:l}}=await s.N.auth.getSession(),n=null!=(a=null==l||null==(e=l.user)?void 0:e.id)?a:null,c=null!=(r=null==l||null==(t=l.user)?void 0:t.email)?r:null;i(n),o(c),n?await f(n,c):h(!1)}catch(e){p((null==e?void 0:e.message)||"Error inicializando sesi\xf3n"),h(!1)}})();let{data:e}=s.N.auth.onAuthStateChange(async(e,t)=>{var a,r,l,s;let n=null!=(l=null==t||null==(a=t.user)?void 0:a.id)?l:null,c=null!=(s=null==t||null==(r=t.user)?void 0:r.email)?s:null;i(n),o(c),n?await f(n,c):(d(null),h(!1))});return()=>{e.subscription.unsubscribe()}},[f]);let N=async()=>{await s.N.auth.signOut(),i(null),o(null),d(null)};return(0,r.jsx)(n.Provider,{value:{userId:a,email:c,profile:u,loading:m,error:x,refreshProfile:v,signOut:N},children:t})}let c=()=>{let e=(0,l.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,642,647,516,358],()=>e(e.s=4091)),_N_E=e.O()}]);