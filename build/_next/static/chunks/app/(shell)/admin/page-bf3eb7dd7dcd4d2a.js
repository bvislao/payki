(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[232],{2895:(e,a,l)=>{Promise.resolve().then(l.bind(l,4434))},4434:(e,a,l)=>{"use strict";l.r(a),l.d(a,{default:()=>o});var s=l(4248),t=l(4564),r=l(9661),n=l(9410),i=l(8440);function d(){let[e,a]=(0,t.useState)([]),[l,r]=(0,t.useState)([]),[d,c]=(0,t.useState)([]),[o,u]=(0,t.useState)([]),[m,h]=(0,t.useState)(""),[x,p]=(0,t.useState)(""),[v,f]=(0,t.useState)([]),[j,N]=(0,t.useState)(!1),[b,g]=(0,t.useState)(""),[y,w]=(0,t.useState)("");async function S(){var e;let{data:a}=await n.N.auth.getSession(),l=null==(e=a.session)?void 0:e.access_token;if(!l)throw Error("No hay sesi\xf3n activa");return l}(0,t.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("operators").select("id,name").order("name");a(null!=e?e:[]);let{data:l}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=l?l:[]);let{data:s}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");c(null!=s?s:[]);let{data:t}=await n.N.from("profiles").select("id,full_name").eq("role","driver").order("full_name");u(null!=t?t:[])})()},[]);let _=async e=>{e.preventDefault(),N(!0);try{let e=await S(),a=await (0,i.Tx)("admin_upsert_fleet",{name:m,operator_id:x,vehicle_ids:v},e);alert("Flota guardada: ".concat(a.fleet_id)),h(""),p(""),f([]);let{data:l}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=l?l:[]);let{data:s}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");c(null!=s?s:[])}catch(e){alert(e instanceof Error?e.message:String(e))}finally{N(!1)}},C=async e=>{if(e.preventDefault(),!b||!y)return void alert("Selecciona chofer y veh\xedculo");N(!0);try{let e=await S();await (0,i.Tx)("admin_assign_driver",{driver_id:b,vehicle_id:y},e),alert("Asignaci\xf3n creada")}catch(e){alert(e instanceof Error?e.message:String(e))}finally{N(!1)}};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("form",{onSubmit:_,className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Crear / Editar Flota"}),(0,s.jsxs)("label",{className:"text-sm",children:["Nombre de flota",(0,s.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:m,onChange:e=>h(e.target.value)})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Operador",(0,s.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:x,onChange:e=>p(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"— selecciona —"}),e.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,s.jsx)("div",{className:"text-sm font-medium mt-2",children:"Veh\xedculos (marcar para incluir en la flota)"}),(0,s.jsx)("div",{className:"max-h-56 overflow-auto border rounded-2xl p-3 grid md:grid-cols-2 gap-2",children:d.map(e=>(0,s.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,s.jsx)("input",{type:"checkbox",checked:v.includes(e.id),onChange:()=>{var a;return a=e.id,void f(e=>e.includes(a)?e.filter(e=>e!==a):[...e,a])}}),(0,s.jsxs)("span",{children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"(flota actual)":""]})]},e.id))}),(0,s.jsx)("button",{className:"btn",disabled:j||!m||!x,children:j?"Guardando…":"Guardar flota"})]}),(0,s.jsxs)("form",{onSubmit:C,className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Asignar Chofer a Veh\xedculo"}),(0,s.jsxs)("label",{className:"text-sm",children:["Chofer",(0,s.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:b,onChange:e=>g(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"— chofer —"}),o.map(e=>(0,s.jsx)("option",{value:e.id,children:e.full_name},e.id))]})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Veh\xedculo",(0,s.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:y,onChange:e=>w(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"— veh\xedculo —"}),d.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"\xb7 (en flota)":""]},e.id))]})]}),(0,s.jsx)("button",{className:"btn",disabled:j||!b||!y,children:j?"Asignando…":"Asignar"})]}),(0,s.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,s.jsx)("h3",{className:"font-semibold mb-3",children:"Flotas"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Nombre"}),(0,s.jsx)("th",{children:"Operador"}),(0,s.jsx)("th",{children:"Activa"})]})}),(0,s.jsx)("tbody",{children:l.map(a=>{var l,t;let r=null!=(t=null==(l=e.find(e=>e.id===a.operator_id))?void 0:l.name)?t:"—";return(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:a.name}),(0,s.jsx)("td",{children:r}),(0,s.jsx)("td",{children:"✔"})]},a.id)})})]})]})]})}function c(){let[e,a]=(0,t.useState)([]),[l,r]=(0,t.useState)([]),[i,d]=(0,t.useState)(""),[c,o]=(0,t.useState)(""),[u,m]=(0,t.useState)(""),[h,x]=(0,t.useState)(!1);(0,t.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("fleets").select("id,name,operator_id").order("name");a(null!=e?e:[])})()},[]);let p=async e=>{if(d(e),!e)return void r([]);let{data:a,error:l}=await n.N.from("vehicles").select("id,code,plate,active,fleet_id").eq("fleet_id",e).order("code");l&&console.error("[vehicles]",l),r(null!=a?a:[])},v=async a=>{if(a.preventDefault(),i&&c&&u){x(!0);try{var l,s;let a=null!=(s=null==(l=e.find(e=>e.id===i))?void 0:l.operator_id)?s:null,{error:t}=await n.N.from("vehicles").insert({code:c,plate:u,active:!0,fleet_id:i,operator_id:a});if(t)throw t;o(""),m(""),await p(i),alert("Veh\xedculo agregado")}catch(e){alert(e instanceof Error?e.message:String(e))}finally{x(!1)}}};return(0,s.jsxs)("div",{className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Flota → Veh\xedculos"}),(0,s.jsxs)("label",{className:"text-sm",children:["Flota",(0,s.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:i,onChange:e=>p(e.target.value),children:[(0,s.jsx)("option",{value:"",children:"— selecciona flota —"}),e.map(e=>(0,s.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),i&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("form",{onSubmit:v,className:"grid gap-3 md:grid-cols-3",children:[(0,s.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"C\xf3digo (BUS-001)",value:c,onChange:e=>o(e.target.value)}),(0,s.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"Placa (ABC-123)",value:u,onChange:e=>m(e.target.value)}),(0,s.jsx)("button",{className:"btn",disabled:h||!c||!u,children:"Agregar veh\xedculo"})]}),(0,s.jsxs)("ul",{className:"text-sm divide-y",children:[l.map(e=>(0,s.jsxs)("li",{className:"py-2 flex justify-between",children:[(0,s.jsxs)("span",{children:[e.code," \xb7 ",e.plate]}),(0,s.jsx)("span",{className:"text-gray-500",children:e.active?"Activo":"Inactivo"})]},e.id)),0===l.length&&(0,s.jsx)("li",{className:"py-2 text-gray-500",children:"Sin veh\xedculos en esta flota."})]})]})]})}function o(){let{profile:e}=(0,r.A)(),[a,l]=(0,t.useState)(!1),[o,u]=(0,t.useState)(0),[m,h]=(0,t.useState)(0),[x,p]=(0,t.useState)(0),[v,f]=(0,t.useState)(0),[j,N]=(0,t.useState)([]),[b,g]=(0,t.useState)([]),[y,w]=(0,t.useState)(""),[S,_]=(0,t.useState)(""),[C,E]=(0,t.useState)(""),[I,A]=(0,t.useState)("driver"),[k,T]=(0,t.useState)(""),[F,O]=(0,t.useState)([{code:"general",label:"General",base_amount:2.5}]);if((0,t.useEffect)(()=>{(async()=>{var e,a;let l=new Date().toISOString().slice(0,10),{data:s}=await n.N.from("transactions").select("amount,type,ts").gte("ts","".concat(l,"T00:00:00Z")),t=(null!=s?s:[]).filter(e=>"ride"===e.type);u(t.reduce((e,a)=>e+Number(a.amount),0)),f(t.length);let{data:r}=await n.N.from("vehicles").select("id,code,plate,active").eq("active",!0);N(null!=r?r:[]),h(null!=(e=null==r?void 0:r.length)?e:0);let{data:i}=await n.N.from("driver_shifts").select("status").eq("status","open");p(null!=(a=null==i?void 0:i.length)?a:0);let{data:d}=await n.N.from("profiles").select("id,full_name").eq("role","driver");g(null!=d?d:[])})()},[]),(null==e?void 0:e.role)!=="admin")return(0,s.jsx)("div",{className:"card p-6",children:"Acceso solo para administradores."});let D=(e,a,l)=>{O(s=>s.map((s,t)=>t===e?{...s,[a]:"base_amount"===a?Number(l):String(l)}:s))};async function q(){var e;let{data:a}=await n.N.auth.getSession(),l=null==(e=a.session)?void 0:e.access_token;if(!l)throw Error("No hay sesi\xf3n activa");return l}let z=async e=>{e.preventDefault(),l(!0);try{let e=await q();await (0,i.Tx)("admin_create_user",{email:y,password:S,full_name:C,role:I},e),alert("Usuario creado correctamente"),w(""),_(""),E("")}catch(e){alert(e instanceof Error?e.message:String(e))}finally{l(!1)}},J=async e=>{e.preventDefault(),l(!0);try{let e=await q();await (0,i.Tx)("admin_upsert_operator",{name:k,fares:F},e),alert("Operador y tarifas guardados"),T(""),O([{code:"general",label:"General",base_amount:2.5}])}catch(e){alert(e instanceof Error?e.message:String(e))}finally{l(!1)}};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid md:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Ingresos Hoy"}),(0,s.jsxs)("div",{className:"text-2xl font-semibold",children:["S/ ",o.toFixed(2)]})]}),(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Unidades Activas"}),(0,s.jsx)("div",{className:"text-2xl font-semibold",children:m})]}),(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Conductores en Ruta"}),(0,s.jsx)("div",{className:"text-2xl font-semibold",children:x})]}),(0,s.jsxs)("div",{className:"card p-4",children:[(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Pasajeros Hoy"}),(0,s.jsx)("div",{className:"text-2xl font-semibold",children:v})]})]}),(0,s.jsxs)("form",{onSubmit:async e=>{e.preventDefault();let a=e.currentTarget.elements.namedItem("title").value,l=e.currentTarget.elements.namedItem("body").value;await (0,i.c9)(a,l,"/"),alert("Enviado a todos los suscritos")},className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Enviar notificaci\xf3n (broadcast)"}),(0,s.jsx)("input",{name:"title",className:"rounded-xl border px-3 py-2",placeholder:"T\xedtulo"}),(0,s.jsx)("input",{name:"body",className:"rounded-xl border px-3 py-2",placeholder:"Mensaje"}),(0,s.jsx)("button",{className:"btn",children:"Enviar"})]}),(0,s.jsx)(d,{}),(0,s.jsxs)("form",{onSubmit:z,className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Crear usuario"}),(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-3",children:[(0,s.jsxs)("label",{className:"text-sm",children:["Email",(0,s.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:y,onChange:e=>w(e.target.value)})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Contrase\xf1a",(0,s.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",type:"password",value:S,onChange:e=>_(e.target.value)})]})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Nombre completo",(0,s.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:C,onChange:e=>E(e.target.value)})]}),(0,s.jsxs)("label",{className:"text-sm",children:["Rol",(0,s.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:I,onChange:e=>A(e.target.value),children:[(0,s.jsx)("option",{value:"driver",children:"Chofer"}),(0,s.jsx)("option",{value:"passenger",children:"Pasajero"})]})]}),(0,s.jsx)("button",{className:"btn",disabled:a,children:a?"Creando…":"Crear usuario"})]}),(0,s.jsxs)("form",{onSubmit:J,className:"card p-4 space-y-3",children:[(0,s.jsx)("h3",{className:"font-semibold",children:"Operador y tarifas"}),(0,s.jsxs)("label",{className:"text-sm",children:["Nombre del operador",(0,s.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:k,onChange:e=>T(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("div",{className:"text-sm font-medium",children:"Tarifas"}),F.map((e,a)=>(0,s.jsxs)("div",{className:"grid md:grid-cols-3 gap-2",children:[(0,s.jsx)("input",{placeholder:"code",className:"rounded-xl border px-3 py-2",value:e.code,onChange:e=>D(a,"code",e.target.value)}),(0,s.jsx)("input",{placeholder:"label",className:"rounded-xl border px-3 py-2",value:e.label,onChange:e=>D(a,"label",e.target.value)}),(0,s.jsx)("input",{placeholder:"base_amount",type:"number",step:"0.01",className:"rounded-xl border px-3 py-2",value:e.base_amount,onChange:e=>D(a,"base_amount",e.target.value)})]},a)),(0,s.jsx)("button",{type:"button",className:"btn-outline",onClick:()=>O(e=>[...e,{code:"",label:"",base_amount:0}]),children:"+ Agregar tarifa"})]}),(0,s.jsx)("button",{className:"btn",disabled:a,children:a?"Guardando…":"Guardar operador"})]}),(0,s.jsx)(c,{}),(0,s.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,s.jsx)("h3",{className:"font-semibold mb-3",children:"Flota"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"ID"}),(0,s.jsx)("th",{children:"C\xf3digo"}),(0,s.jsx)("th",{children:"Placa"}),(0,s.jsx)("th",{children:"Estado"})]})}),(0,s.jsx)("tbody",{children:j.map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.id}),(0,s.jsx)("td",{children:e.code}),(0,s.jsx)("td",{children:e.plate}),(0,s.jsx)("td",{children:e.active?"Activo":"Inactivo"})]},e.id))})]})]}),(0,s.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,s.jsx)("h3",{className:"font-semibold mb-3",children:"Conductores"}),(0,s.jsxs)("table",{className:"table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"ID"}),(0,s.jsx)("th",{children:"Nombre"})]})}),(0,s.jsx)("tbody",{children:b.map(e=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.id}),(0,s.jsx)("td",{children:e.full_name})]},e.id))})]})]})]})}},8440:(e,a,l)=>{"use strict";l.d(a,{Tx:()=>t,c9:()=>r});var s=l(9410);async function t(e,a,l){let s="".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/").concat(e),t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(l)},body:JSON.stringify(a)}),r=await t.json();if(!t.ok)throw Error((null==r?void 0:r.error)||"Function error");return r}async function r(e,a,l){var r;let n=null==(r=(await s.N.auth.getSession()).data.session)?void 0:r.access_token;if(!n)throw Error("No auth");return t("send_broadcast",{title:e,body:a,url:l},n)}},9410:(e,a,l)=>{"use strict";l.d(a,{N:()=>s});let s=(0,l(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,l)=>{"use strict";l.d(a,{A:()=>d,AuthProvider:()=>i});var s=l(4248),t=l(4564),r=l(9410);let n=(0,t.createContext)(null);function i(e){let{children:a}=e,[l,i]=(0,t.useState)(null),[d,c]=(0,t.useState)(null),[o,u]=(0,t.useState)(null),[m,h]=(0,t.useState)(!0),x=async(e,a)=>{let{data:l}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();if(l)return void u(l);let{data:s,error:t}=await r.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(t){console.error("[ensure_profile rpc] error",t),u(null);return}u(null!=s?s:null)};(0,t.useEffect)(()=>{(async()=>{var e,a,l,s,t,n;let{data:d}=await r.N.auth.getSession(),o=null!=(t=null==(a=d.session)||null==(e=a.user)?void 0:e.id)?t:null,u=null!=(n=null==(s=d.session)||null==(l=s.user)?void 0:l.email)?n:null;i(o),c(u),o&&await x(o,u),h(!1)})();let{data:e}=r.N.auth.onAuthStateChange(async(e,a)=>{var l,s,t,r;let n=null!=(t=null==a||null==(l=a.user)?void 0:l.id)?t:null,d=null!=(r=null==a||null==(s=a.user)?void 0:s.email)?r:null;i(n),c(d),n?await x(n,d):u(null)});return()=>{e.subscription.unsubscribe()}},[]);let p=async()=>{await r.N.auth.signOut()};return(0,s.jsx)(n.Provider,{value:{userId:l,email:d,profile:o,loading:m,signOut:p},children:a})}let d=()=>{let e=(0,t.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,647,516,358],()=>e(e.s=2895)),_N_E=e.O()}]);