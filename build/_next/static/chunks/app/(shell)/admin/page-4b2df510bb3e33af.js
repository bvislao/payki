(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[232],{1379:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>h});var l=t(4248),s=t(4564),r=t(9661),n=t(9410),i=t(8440),d=t(8299);function c(){let[e,a]=(0,s.useState)([]),[t,r]=(0,s.useState)([]),[c,o]=(0,s.useState)([]),[u,m]=(0,s.useState)([]),[h,x]=(0,s.useState)(""),[p,f]=(0,s.useState)(""),[v,j]=(0,s.useState)([]),[N,b]=(0,s.useState)(!1),[y,g]=(0,s.useState)(""),[w,S]=(0,s.useState)("");async function _(){var e;let{data:a}=await n.N.auth.getSession(),t=null==(e=a.session)?void 0:e.access_token;if(!t)throw Error("No hay sesi\xf3n activa");return t}(0,s.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("operators").select("id,name").order("name");a(null!=e?e:[]);let{data:t}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=t?t:[]);let{data:l}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");o(null!=l?l:[]);let{data:s}=await n.N.from("profiles").select("id,full_name").eq("role","driver").order("full_name");m(null!=s?s:[])})()},[]);let C=async e=>{e.preventDefault(),b(!0);try{let e=await _(),a=await (0,i.Tx)("admin_upsert_fleet",{name:h,operator_id:p,vehicle_ids:v},e);d.Ay.success("Flota guardada: ".concat(a.fleet_id)),x(""),f(""),j([]);let{data:t}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=t?t:[]);let{data:l}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");o(null!=l?l:[])}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{b(!1)}},A=async e=>{if(e.preventDefault(),!y||!w)return alert("Selecciona chofer y veh\xedculo");b(!0);try{var a;let e=null==(a=(await n.N.auth.getSession()).data.session)?void 0:a.access_token,t="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),l=await fetch("".concat(t,"/admin_assign_driver"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({driver_id:y,vehicle_id:w})});if(!l.ok)throw Error(await l.text());let{data:s}=await n.N.from("vehicles").select("id, code, plate, fleet_id, operator_id, current_driver_id").order("code");o(s||[]),d.Ay.success("Asignaci\xf3n creada")}catch(e){d.Ay.error(e.message)}finally{b(!1)}};return(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("form",{onSubmit:C,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Crear / Editar Flota"}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre de flota",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:h,onChange:e=>x(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Operador",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:p,onChange:e=>f(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— selecciona —"}),e.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,l.jsx)("div",{className:"text-sm font-medium mt-2",children:"Veh\xedculos (marcar para incluir en la flota)"}),(0,l.jsx)("div",{className:"max-h-56 overflow-auto border rounded-2xl p-3 grid md:grid-cols-2 gap-2",children:c.map(e=>(0,l.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,l.jsx)("input",{type:"checkbox",checked:v.includes(e.id),onChange:()=>{var a;return a=e.id,void j(e=>e.includes(a)?e.filter(e=>e!==a):[...e,a])}}),(0,l.jsxs)("span",{children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"(flota actual)":""]})]},e.id))}),(0,l.jsx)("button",{className:"btn",disabled:N||!h||!p,children:N?"Guardando…":"Guardar flota"})]}),(0,l.jsxs)("form",{onSubmit:A,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Asignar Chofer a Veh\xedculo"}),(0,l.jsxs)("label",{className:"text-sm",children:["Chofer",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:y,onChange:e=>g(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— chofer —"}),u.map(e=>(0,l.jsx)("option",{value:e.id,children:e.full_name},e.id))]})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Veh\xedculo",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:w,onChange:e=>S(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— veh\xedculo —"}),c.map(e=>(0,l.jsxs)("option",{value:e.id,children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"\xb7 (en flota)":""," ",e.current_driver_id?"\xb7 (con chofer)":""]},e.id))]})]}),(0,l.jsx)("button",{className:"btn",disabled:N||!y||!w,children:N?"Asignando…":"Asignar"})]}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Flotas"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"Nombre"}),(0,l.jsx)("th",{children:"Operador"}),(0,l.jsx)("th",{children:"Activa"})]})}),(0,l.jsx)("tbody",{children:t.map(a=>{var t,s;let r=null!=(s=null==(t=e.find(e=>e.id===a.operator_id))?void 0:t.name)?s:"—";return(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:a.name}),(0,l.jsx)("td",{children:r}),(0,l.jsx)("td",{children:"✔"})]},a.id)})})]})]})]})}function o(){let[e,a]=(0,s.useState)([]),[t,r]=(0,s.useState)([]),[i,c]=(0,s.useState)(""),[o,u]=(0,s.useState)(""),[m,h]=(0,s.useState)(""),[x,p]=(0,s.useState)(!1);(0,s.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("fleets").select("id,name,operator_id").order("name");a(null!=e?e:[])})()},[]);let f=async e=>{if(c(e),!e)return void r([]);let{data:a,error:t}=await n.N.from("vehicles").select("id,code,plate,active,fleet_id").eq("fleet_id",e).order("code");t&&console.error("[vehicles]",t),r(null!=a?a:[])},v=async a=>{if(a.preventDefault(),i&&o&&m){p(!0);try{var t,l;let a=null!=(l=null==(t=e.find(e=>e.id===i))?void 0:t.operator_id)?l:null,{error:s}=await n.N.from("vehicles").insert({code:o,plate:m,active:!0,fleet_id:i,operator_id:a});if(s)throw s;u(""),h(""),await f(i),d.Ay.success("Veh\xedculo agregado")}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{p(!1)}}};return(0,l.jsxs)("div",{className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Flota → Veh\xedculos"}),(0,l.jsxs)("label",{className:"text-sm",children:["Flota",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:i,onChange:e=>f(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— selecciona flota —"}),e.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),i&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("form",{onSubmit:v,className:"grid gap-3 md:grid-cols-3",children:[(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"C\xf3digo (BUS-001)",value:o,onChange:e=>u(e.target.value)}),(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"Placa (ABC-123)",value:m,onChange:e=>h(e.target.value)}),(0,l.jsx)("button",{className:"btn",disabled:x||!o||!m,children:"Agregar veh\xedculo"})]}),(0,l.jsxs)("ul",{className:"text-sm divide-y",children:[t.map(e=>(0,l.jsxs)("li",{className:"py-2 flex justify-between",children:[(0,l.jsxs)("span",{children:[e.code," \xb7 ",e.plate]}),(0,l.jsx)("span",{className:"text-gray-500",children:e.active?"Activo":"Inactivo"})]},e.id)),0===t.length&&(0,l.jsx)("li",{className:"py-2 text-gray-500",children:"Sin veh\xedculos en esta flota."})]})]})]})}var u=t(7637);function m(){let{profile:e}=(0,r.A)(),{start:a,stop:t}=(0,u.M)(),[n,c]=(0,s.useState)("Aviso PAYKI"),[o,m]=(0,s.useState)("Mensaje general"),[h,x]=(0,s.useState)("/");if((null==e?void 0:e.role)!=="admin")return null;let p=async e=>{e.preventDefault(),a();try{var l,s;let e=await (0,i.c9)(n,o,h);d.Ay.success("Notificado: ".concat(null!=(l=e.sent)?l:0," (fallidos: ").concat(null!=(s=e.failed)?s:0,")"))}catch(e){d.Ay.error(e.message||"Error enviando notificaciones")}finally{t()}};return(0,l.jsxs)("form",{onSubmit:p,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Notificaci\xf3n a todos"}),(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"T\xedtulo",value:n,onChange:e=>c(e.target.value)}),(0,l.jsx)("textarea",{className:"rounded-xl border px-3 py-2",placeholder:"Mensaje",value:o,onChange:e=>m(e.target.value)}),(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"URL al abrir",value:h,onChange:e=>x(e.target.value)}),(0,l.jsx)("button",{className:"btn w-full",children:"Enviar a todos"})]})}function h(){let{profile:e}=(0,r.A)(),[a,t]=(0,s.useState)(!1),[u,h]=(0,s.useState)(0),[x,p]=(0,s.useState)(0),[f,v]=(0,s.useState)(0),[j,N]=(0,s.useState)(0),[b,y]=(0,s.useState)([]),[g,w]=(0,s.useState)([]),[S,_]=(0,s.useState)(""),[C,A]=(0,s.useState)(""),[E,I]=(0,s.useState)(""),[O,k]=(0,s.useState)("driver"),[T,M]=(0,s.useState)(""),[D,F]=(0,s.useState)([{code:"general",label:"General",base_amount:2.5}]);if((0,s.useEffect)(()=>{(async()=>{var e,a;let t=new Date().toISOString().slice(0,10),{data:l}=await n.N.from("transactions").select("amount,type,ts").gte("ts","".concat(t,"T00:00:00Z")),s=(null!=l?l:[]).filter(e=>"ride"===e.type);h(s.reduce((e,a)=>e+Number(a.amount),0)),N(s.length);let{data:r}=await n.N.from("vehicles").select("id,code,plate,active").eq("active",!0);y(null!=r?r:[]),p(null!=(e=null==r?void 0:r.length)?e:0);let{data:i}=await n.N.from("driver_shifts").select("status").eq("status","open");v(null!=(a=null==i?void 0:i.length)?a:0);let{data:d}=await n.N.from("profiles").select("id,full_name").eq("role","driver");w(null!=d?d:[])})()},[]),(null==e?void 0:e.role)!=="admin")return(0,l.jsx)("div",{className:"card p-6",children:"Acceso solo para administradores."});let P=(e,a,t)=>{F(l=>l.map((l,s)=>s===e?{...l,[a]:"base_amount"===a?Number(t):String(t)}:l))};async function q(){var e;let{data:a}=await n.N.auth.getSession(),t=null==(e=a.session)?void 0:e.access_token;if(!t)throw Error("No hay sesi\xf3n activa");return t}let J=async e=>{e.preventDefault(),t(!0);try{let e=await q();await (0,i.Tx)("admin_create_user",{email:S,password:C,full_name:E,role:O},e),d.Ay.success("Usuario creado correctamente"),_(""),A(""),I("")}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{t(!1)}},z=async e=>{e.preventDefault(),t(!0);try{let e=await q();await (0,i.Tx)("admin_upsert_operator",{name:T,fares:D},e),d.Ay.success("Operador y tarifas guardados"),M(""),F([{code:"general",label:"General",base_amount:2.5}])}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{t(!1)}};return(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"grid md:grid-cols-4 gap-4",children:[(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Ingresos Hoy"}),(0,l.jsxs)("div",{className:"text-2xl font-semibold",children:["S/ ",u.toFixed(2)]})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Unidades Activas"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:x})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Conductores en Ruta"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:f})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Pasajeros Hoy"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:j})]})]}),(0,l.jsx)(m,{}),(0,l.jsx)(c,{}),(0,l.jsxs)("form",{onSubmit:J,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Crear usuario"}),(0,l.jsxs)("div",{className:"grid md:grid-cols-2 gap-3",children:[(0,l.jsxs)("label",{className:"text-sm",children:["Email",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:S,onChange:e=>_(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Contrase\xf1a",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",type:"password",value:C,onChange:e=>A(e.target.value)})]})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre completo",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:E,onChange:e=>I(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Rol",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:O,onChange:e=>k(e.target.value),children:[(0,l.jsx)("option",{value:"driver",children:"Chofer"}),(0,l.jsx)("option",{value:"passenger",children:"Pasajero"})]})]}),(0,l.jsx)("button",{className:"btn",disabled:a,children:a?"Creando…":"Crear usuario"})]}),(0,l.jsxs)("form",{onSubmit:z,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Operador y tarifas"}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre del operador",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:T,onChange:e=>M(e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("div",{className:"text-sm font-medium",children:"Tarifas"}),D.map((e,a)=>(0,l.jsxs)("div",{className:"grid md:grid-cols-3 gap-2",children:[(0,l.jsx)("input",{placeholder:"code",className:"rounded-xl border px-3 py-2",value:e.code,onChange:e=>P(a,"code",e.target.value)}),(0,l.jsx)("input",{placeholder:"label",className:"rounded-xl border px-3 py-2",value:e.label,onChange:e=>P(a,"label",e.target.value)}),(0,l.jsx)("input",{placeholder:"base_amount",type:"number",step:"0.01",className:"rounded-xl border px-3 py-2",value:e.base_amount,onChange:e=>P(a,"base_amount",e.target.value)})]},a)),(0,l.jsx)("button",{type:"button",className:"btn-outline",onClick:()=>F(e=>[...e,{code:"",label:"",base_amount:0}]),children:"+ Agregar tarifa"})]}),(0,l.jsx)("button",{className:"btn",disabled:a,children:a?"Guardando…":"Guardar operador"})]}),(0,l.jsx)(o,{}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Flota"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"ID"}),(0,l.jsx)("th",{children:"C\xf3digo"}),(0,l.jsx)("th",{children:"Placa"}),(0,l.jsx)("th",{children:"Estado"})]})}),(0,l.jsx)("tbody",{children:b.map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:e.id}),(0,l.jsx)("td",{children:e.code}),(0,l.jsx)("td",{children:e.plate}),(0,l.jsx)("td",{children:e.active?"Activo":"Inactivo"})]},e.id))})]})]}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Conductores"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"ID"}),(0,l.jsx)("th",{children:"Nombre"})]})}),(0,l.jsx)("tbody",{children:g.map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:e.id}),(0,l.jsx)("td",{children:e.full_name})]},e.id))})]})]})]})}},2895:(e,a,t)=>{Promise.resolve().then(t.bind(t,1379))},7637:(e,a,t)=>{"use strict";t.d(a,{M:()=>i,o:()=>n});var l=t(4248),s=t(4564);let r=(0,s.createContext)(null);function n(e){let{children:a}=e,[t,n]=(0,s.useState)(0),i=()=>n(e=>e+1),d=()=>n(e=>Math.max(0,e-1));(0,s.useEffect)(()=>{let e=window.fetch;return window.fetch=async function(){for(var a=arguments.length,t=Array(a),l=0;l<a;l++)t[l]=arguments[l];n(e=>e+1);try{return await e(...t)}finally{n(e=>Math.max(0,e-1))}},()=>{window.fetch=e}},[]);let c=(0,s.useMemo)(()=>({pending:t,start:i,stop:d}),[t]);return(0,l.jsx)(r.Provider,{value:c,children:a})}let i=()=>{let e=(0,s.useContext)(r);if(!e)throw Error("LoadingProvider missing");return e}},8440:(e,a,t)=>{"use strict";t.d(a,{Tx:()=>s,c9:()=>r});var l=t(9410);async function s(e,a,t){let l="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),s=await fetch("".concat(l,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer ".concat(t)}:{}},body:JSON.stringify(a)}),r=await s.text(),n=null;try{n=r?JSON.parse(r):null}catch(e){}if(!s.ok)throw Error(n&&n.error?n.error:r||s.statusText);return n}async function r(e,a,t){var r;let n=null==(r=(await l.N.auth.getSession()).data.session)?void 0:r.access_token;if(!n)throw Error("No auth");return s("send_broadcast",{title:e,body:a,url:t},n)}},9410:(e,a,t)=>{"use strict";t.d(a,{N:()=>l});let l=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,t)=>{"use strict";t.d(a,{A:()=>d,O:()=>i});var l=t(4248),s=t(4564),r=t(9410);let n=(0,s.createContext)(null);function i(e){let{children:a}=e,[t,i]=(0,s.useState)(null),[d,c]=(0,s.useState)(null),[o,u]=(0,s.useState)(null),[m,h]=(0,s.useState)(!0),x=async(e,a)=>{try{let{data:t}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();if(t)return void u(t);let{data:l,error:s}=await r.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(s){console.error("[ensure_profile] error",s),u(null);return}u(l)}catch(e){console.error("[fetchOrCreate] ",e),u(null)}};(0,s.useEffect)(()=>{let e=!0;(async()=>{var a,t,l,s;let{data:{session:n}}=await r.N.auth.getSession(),d=null!=(l=null==n||null==(a=n.user)?void 0:a.id)?l:null,o=null!=(s=null==n||null==(t=n.user)?void 0:t.email)?s:null;e&&(i(d),c(o),d&&await x(d,o),e&&h(!1))})();let{data:a}=r.N.auth.onAuthStateChange(async(e,a)=>{var t,l,s,r;let n=null!=(s=null==a||null==(t=a.user)?void 0:t.id)?s:null,d=null!=(r=null==a||null==(l=a.user)?void 0:l.email)?r:null;i(n),c(d),n?await x(n,d):u(null)});return()=>{e=!1,a.subscription.unsubscribe()}},[]);let p=async()=>{await r.N.auth.signOut()};return(0,l.jsx)(n.Provider,{value:{userId:t,email:d,profile:o,loading:m,signOut:p},children:a})}let d=()=>{let e=(0,s.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=2895)),_N_E=e.O()}]);