(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[232],{2895:(e,a,s)=>{Promise.resolve().then(s.bind(s,4434))},4434:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>u});var l=s(4248),t=s(4564),r=s(9661),n=s(9410),i=s(8440),d=s(8299);function c(){let[e,a]=(0,t.useState)([]),[s,r]=(0,t.useState)([]),[c,o]=(0,t.useState)([]),[u,m]=(0,t.useState)([]),[h,x]=(0,t.useState)(""),[p,v]=(0,t.useState)(""),[f,j]=(0,t.useState)([]),[N,b]=(0,t.useState)(!1),[y,g]=(0,t.useState)(""),[w,_]=(0,t.useState)("");async function S(){var e;let{data:a}=await n.N.auth.getSession(),s=null==(e=a.session)?void 0:e.access_token;if(!s)throw Error("No hay sesi\xf3n activa");return s}(0,t.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("operators").select("id,name").order("name");a(null!=e?e:[]);let{data:s}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=s?s:[]);let{data:l}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");o(null!=l?l:[]);let{data:t}=await n.N.from("profiles").select("id,full_name").eq("role","driver").order("full_name");m(null!=t?t:[])})()},[]);let C=async e=>{e.preventDefault(),b(!0);try{let e=await S(),a=await (0,i.Tx)("admin_upsert_fleet",{name:h,operator_id:p,vehicle_ids:f},e);d.Ay.success("Flota guardada: ".concat(a.fleet_id)),x(""),v(""),j([]);let{data:s}=await n.N.from("fleets").select("id,name,operator_id").order("name");r(null!=s?s:[]);let{data:l}=await n.N.from("vehicles").select("id,code,plate,fleet_id,operator_id").order("code");o(null!=l?l:[])}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{b(!1)}},A=async e=>{if(e.preventDefault(),!y||!w)return alert("Selecciona chofer y veh\xedculo");b(!0);try{var a;let e=null==(a=(await n.N.auth.getSession()).data.session)?void 0:a.access_token,s="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),l=await fetch("".concat(s,"/admin_assign_driver"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({driver_id:y,vehicle_id:w})});if(!l.ok)throw Error(await l.text());let{data:t}=await n.N.from("vehicles").select("id, code, plate, fleet_id, operator_id, current_driver_id").order("code");o(t||[]),d.Ay.success("Asignaci\xf3n creada")}catch(e){d.Ay.error(e.message)}finally{b(!1)}};return(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("form",{onSubmit:C,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Crear / Editar Flota"}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre de flota",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:h,onChange:e=>x(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Operador",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:p,onChange:e=>v(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— selecciona —"}),e.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),(0,l.jsx)("div",{className:"text-sm font-medium mt-2",children:"Veh\xedculos (marcar para incluir en la flota)"}),(0,l.jsx)("div",{className:"max-h-56 overflow-auto border rounded-2xl p-3 grid md:grid-cols-2 gap-2",children:c.map(e=>(0,l.jsxs)("label",{className:"flex items-center gap-2 text-sm",children:[(0,l.jsx)("input",{type:"checkbox",checked:f.includes(e.id),onChange:()=>{var a;return a=e.id,void j(e=>e.includes(a)?e.filter(e=>e!==a):[...e,a])}}),(0,l.jsxs)("span",{children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"(flota actual)":""]})]},e.id))}),(0,l.jsx)("button",{className:"btn",disabled:N||!h||!p,children:N?"Guardando…":"Guardar flota"})]}),(0,l.jsxs)("form",{onSubmit:A,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Asignar Chofer a Veh\xedculo"}),(0,l.jsxs)("label",{className:"text-sm",children:["Chofer",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:y,onChange:e=>g(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— chofer —"}),u.map(e=>(0,l.jsx)("option",{value:e.id,children:e.full_name},e.id))]})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Veh\xedculo",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:w,onChange:e=>_(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— veh\xedculo —"}),c.map(e=>(0,l.jsxs)("option",{value:e.id,children:[e.code," \xb7 ",e.plate," ",e.fleet_id?"\xb7 (en flota)":""," ",e.current_driver_id?"\xb7 (con chofer)":""]},e.id))]})]}),(0,l.jsx)("button",{className:"btn",disabled:N||!y||!w,children:N?"Asignando…":"Asignar"})]}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Flotas"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"Nombre"}),(0,l.jsx)("th",{children:"Operador"}),(0,l.jsx)("th",{children:"Activa"})]})}),(0,l.jsx)("tbody",{children:s.map(a=>{var s,t;let r=null!=(t=null==(s=e.find(e=>e.id===a.operator_id))?void 0:s.name)?t:"—";return(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:a.name}),(0,l.jsx)("td",{children:r}),(0,l.jsx)("td",{children:"✔"})]},a.id)})})]})]})]})}function o(){let[e,a]=(0,t.useState)([]),[s,r]=(0,t.useState)([]),[i,c]=(0,t.useState)(""),[o,u]=(0,t.useState)(""),[m,h]=(0,t.useState)(""),[x,p]=(0,t.useState)(!1);(0,t.useEffect)(()=>{(async()=>{let{data:e}=await n.N.from("fleets").select("id,name,operator_id").order("name");a(null!=e?e:[])})()},[]);let v=async e=>{if(c(e),!e)return void r([]);let{data:a,error:s}=await n.N.from("vehicles").select("id,code,plate,active,fleet_id").eq("fleet_id",e).order("code");s&&console.error("[vehicles]",s),r(null!=a?a:[])},f=async a=>{if(a.preventDefault(),i&&o&&m){p(!0);try{var s,l;let a=null!=(l=null==(s=e.find(e=>e.id===i))?void 0:s.operator_id)?l:null,{error:t}=await n.N.from("vehicles").insert({code:o,plate:m,active:!0,fleet_id:i,operator_id:a});if(t)throw t;u(""),h(""),await v(i),d.Ay.success("Veh\xedculo agregado")}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{p(!1)}}};return(0,l.jsxs)("div",{className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Flota → Veh\xedculos"}),(0,l.jsxs)("label",{className:"text-sm",children:["Flota",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:i,onChange:e=>v(e.target.value),children:[(0,l.jsx)("option",{value:"",children:"— selecciona flota —"}),e.map(e=>(0,l.jsx)("option",{value:e.id,children:e.name},e.id))]})]}),i&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("form",{onSubmit:f,className:"grid gap-3 md:grid-cols-3",children:[(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"C\xf3digo (BUS-001)",value:o,onChange:e=>u(e.target.value)}),(0,l.jsx)("input",{className:"rounded-xl border px-3 py-2",placeholder:"Placa (ABC-123)",value:m,onChange:e=>h(e.target.value)}),(0,l.jsx)("button",{className:"btn",disabled:x||!o||!m,children:"Agregar veh\xedculo"})]}),(0,l.jsxs)("ul",{className:"text-sm divide-y",children:[s.map(e=>(0,l.jsxs)("li",{className:"py-2 flex justify-between",children:[(0,l.jsxs)("span",{children:[e.code," \xb7 ",e.plate]}),(0,l.jsx)("span",{className:"text-gray-500",children:e.active?"Activo":"Inactivo"})]},e.id)),0===s.length&&(0,l.jsx)("li",{className:"py-2 text-gray-500",children:"Sin veh\xedculos en esta flota."})]})]})]})}function u(){let{profile:e}=(0,r.A)(),[a,s]=(0,t.useState)(!1),[u,m]=(0,t.useState)(0),[h,x]=(0,t.useState)(0),[p,v]=(0,t.useState)(0),[f,j]=(0,t.useState)(0),[N,b]=(0,t.useState)([]),[y,g]=(0,t.useState)([]),[w,_]=(0,t.useState)(""),[S,C]=(0,t.useState)(""),[A,E]=(0,t.useState)(""),[I,k]=(0,t.useState)("driver"),[O,T]=(0,t.useState)(""),[F,D]=(0,t.useState)([{code:"general",label:"General",base_amount:2.5}]);if((0,t.useEffect)(()=>{(async()=>{var e,a;let s=new Date().toISOString().slice(0,10),{data:l}=await n.N.from("transactions").select("amount,type,ts").gte("ts","".concat(s,"T00:00:00Z")),t=(null!=l?l:[]).filter(e=>"ride"===e.type);m(t.reduce((e,a)=>e+Number(a.amount),0)),j(t.length);let{data:r}=await n.N.from("vehicles").select("id,code,plate,active").eq("active",!0);b(null!=r?r:[]),x(null!=(e=null==r?void 0:r.length)?e:0);let{data:i}=await n.N.from("driver_shifts").select("status").eq("status","open");v(null!=(a=null==i?void 0:i.length)?a:0);let{data:d}=await n.N.from("profiles").select("id,full_name").eq("role","driver");g(null!=d?d:[])})()},[]),(null==e?void 0:e.role)!=="admin")return(0,l.jsx)("div",{className:"card p-6",children:"Acceso solo para administradores."});let q=(e,a,s)=>{D(l=>l.map((l,t)=>t===e?{...l,[a]:"base_amount"===a?Number(s):String(s)}:l))};async function z(){var e;let{data:a}=await n.N.auth.getSession(),s=null==(e=a.session)?void 0:e.access_token;if(!s)throw Error("No hay sesi\xf3n activa");return s}let J=async e=>{e.preventDefault(),s(!0);try{let e=await z();await (0,i.Tx)("admin_create_user",{email:w,password:S,full_name:A,role:I},e),d.Ay.success("Usuario creado correctamente"),_(""),C(""),E("")}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{s(!1)}},P=async e=>{e.preventDefault(),s(!0);try{let e=await z();await (0,i.Tx)("admin_upsert_operator",{name:O,fares:F},e),d.Ay.success("Operador y tarifas guardados"),T(""),D([{code:"general",label:"General",base_amount:2.5}])}catch(a){let e=a instanceof Error?a.message:String(a);d.Ay.error(e)}finally{s(!1)}};return(0,l.jsxs)("div",{className:"space-y-6",children:[(0,l.jsxs)("div",{className:"grid md:grid-cols-4 gap-4",children:[(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Ingresos Hoy"}),(0,l.jsxs)("div",{className:"text-2xl font-semibold",children:["S/ ",u.toFixed(2)]})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Unidades Activas"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:h})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Conductores en Ruta"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:p})]}),(0,l.jsxs)("div",{className:"card p-4",children:[(0,l.jsx)("div",{className:"text-xs text-gray-500",children:"Pasajeros Hoy"}),(0,l.jsx)("div",{className:"text-2xl font-semibold",children:f})]})]}),(0,l.jsxs)("form",{onSubmit:async e=>{e.preventDefault();let a=e.currentTarget.elements.namedItem("title").value,s=e.currentTarget.elements.namedItem("body").value;await (0,i.c9)(a,s,"/"),d.Ay.success("Enviado a todos los suscritos")},className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Enviar notificaci\xf3n (broadcast)"}),(0,l.jsx)("input",{name:"title",className:"rounded-xl border px-3 py-2",placeholder:"T\xedtulo"}),(0,l.jsx)("input",{name:"body",className:"rounded-xl border px-3 py-2",placeholder:"Mensaje"}),(0,l.jsx)("button",{className:"btn",children:"Enviar"})]}),(0,l.jsx)(c,{}),(0,l.jsxs)("form",{onSubmit:J,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Crear usuario"}),(0,l.jsxs)("div",{className:"grid md:grid-cols-2 gap-3",children:[(0,l.jsxs)("label",{className:"text-sm",children:["Email",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:w,onChange:e=>_(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Contrase\xf1a",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",type:"password",value:S,onChange:e=>C(e.target.value)})]})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre completo",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:A,onChange:e=>E(e.target.value)})]}),(0,l.jsxs)("label",{className:"text-sm",children:["Rol",(0,l.jsxs)("select",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:I,onChange:e=>k(e.target.value),children:[(0,l.jsx)("option",{value:"driver",children:"Chofer"}),(0,l.jsx)("option",{value:"passenger",children:"Pasajero"})]})]}),(0,l.jsx)("button",{className:"btn",disabled:a,children:a?"Creando…":"Crear usuario"})]}),(0,l.jsxs)("form",{onSubmit:P,className:"card p-4 space-y-3",children:[(0,l.jsx)("h3",{className:"font-semibold",children:"Operador y tarifas"}),(0,l.jsxs)("label",{className:"text-sm",children:["Nombre del operador",(0,l.jsx)("input",{className:"mt-1 w-full rounded-xl border px-3 py-2",value:O,onChange:e=>T(e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsx)("div",{className:"text-sm font-medium",children:"Tarifas"}),F.map((e,a)=>(0,l.jsxs)("div",{className:"grid md:grid-cols-3 gap-2",children:[(0,l.jsx)("input",{placeholder:"code",className:"rounded-xl border px-3 py-2",value:e.code,onChange:e=>q(a,"code",e.target.value)}),(0,l.jsx)("input",{placeholder:"label",className:"rounded-xl border px-3 py-2",value:e.label,onChange:e=>q(a,"label",e.target.value)}),(0,l.jsx)("input",{placeholder:"base_amount",type:"number",step:"0.01",className:"rounded-xl border px-3 py-2",value:e.base_amount,onChange:e=>q(a,"base_amount",e.target.value)})]},a)),(0,l.jsx)("button",{type:"button",className:"btn-outline",onClick:()=>D(e=>[...e,{code:"",label:"",base_amount:0}]),children:"+ Agregar tarifa"})]}),(0,l.jsx)("button",{className:"btn",disabled:a,children:a?"Guardando…":"Guardar operador"})]}),(0,l.jsx)(o,{}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Flota"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"ID"}),(0,l.jsx)("th",{children:"C\xf3digo"}),(0,l.jsx)("th",{children:"Placa"}),(0,l.jsx)("th",{children:"Estado"})]})}),(0,l.jsx)("tbody",{children:N.map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:e.id}),(0,l.jsx)("td",{children:e.code}),(0,l.jsx)("td",{children:e.plate}),(0,l.jsx)("td",{children:e.active?"Activo":"Inactivo"})]},e.id))})]})]}),(0,l.jsxs)("div",{className:"card p-4 overflow-x-auto",children:[(0,l.jsx)("h3",{className:"font-semibold mb-3",children:"Conductores"}),(0,l.jsxs)("table",{className:"table",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"ID"}),(0,l.jsx)("th",{children:"Nombre"})]})}),(0,l.jsx)("tbody",{children:y.map(e=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{children:e.id}),(0,l.jsx)("td",{children:e.full_name})]},e.id))})]})]})]})}},8440:(e,a,s)=>{"use strict";s.d(a,{Tx:()=>t,c9:()=>r});var l=s(9410);async function t(e,a,s){let l="".concat("https://exyxexamvwfvwxjjfqpl.supabase.co","/functions/v1/").concat(e),t=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify(a)}),r=await t.json();if(!t.ok)throw Error((null==r?void 0:r.error)||"Function error");return r}async function r(e,a,s){var r;let n=null==(r=(await l.N.auth.getSession()).data.session)?void 0:r.access_token;if(!n)throw Error("No auth");return t("send_broadcast",{title:e,body:a,url:s},n)}},9410:(e,a,s)=>{"use strict";s.d(a,{N:()=>l});let l=(0,s(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,s)=>{"use strict";s.d(a,{A:()=>d,AuthProvider:()=>i});var l=s(4248),t=s(4564),r=s(9410);let n=(0,t.createContext)(null);function i(e){let{children:a}=e,[s,i]=(0,t.useState)(null),[d,c]=(0,t.useState)(null),[o,u]=(0,t.useState)(null),[m,h]=(0,t.useState)(!0),x=async(e,a)=>{let{data:s}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();if(s)return void u(s);let{data:l,error:t}=await r.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(t){console.error("[ensure_profile rpc] error",t),u(null);return}u(null!=l?l:null)};(0,t.useEffect)(()=>{(async()=>{var e,a,s,l,t,n;let{data:d}=await r.N.auth.getSession(),o=null!=(t=null==(a=d.session)||null==(e=a.user)?void 0:e.id)?t:null,u=null!=(n=null==(l=d.session)||null==(s=l.user)?void 0:s.email)?n:null;i(o),c(u),o&&await x(o,u),h(!1)})();let{data:e}=r.N.auth.onAuthStateChange(async(e,a)=>{var s,l,t,r;let n=null!=(t=null==a||null==(s=a.user)?void 0:s.id)?t:null,d=null!=(r=null==a||null==(l=a.user)?void 0:l.email)?r:null;i(n),c(d),n?await x(n,d):u(null)});return()=>{e.subscription.unsubscribe()}},[]);let p=async()=>{await r.N.auth.signOut()};return(0,l.jsx)(n.Provider,{value:{userId:s,email:d,profile:o,loading:m,signOut:p},children:a})}let d=()=>{let e=(0,t.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,299,647,516,358],()=>e(e.s=2895)),_N_E=e.O()}]);