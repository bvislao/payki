(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[540],{451:(e,a,t)=>{"use strict";t.d(a,{A:()=>d});var s=t(4248),l=t(7642),r=t.n(l),n=t(9661),i=t(8650),c=t(5523);function d(e){let{role:a,children:t}=e,{loading:l,error:d,userId:o,profile:u}=(0,n.A)();return l?(0,s.jsx)("div",{className:"min-h-[50vh] flex items-center justify-center",children:(0,s.jsx)(i.A,{className:"h-6 w-6 animate-spin"})}):d?(0,s.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,s.jsxs)("div",{className:"text-sm text-red-600",children:["Error: ",d]}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:"Refresca e int\xe9ntalo nuevamente."})]}):o?(null==u?void 0:u.role)!==a?(0,s.jsxs)("div",{className:"card p-6 text-center space-y-2",children:[(0,s.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,s.jsxs)("div",{className:"text-sm",children:["Acceso restringido. Requiere rol ",(0,s.jsx)("b",{children:a}),"."]})]}):(0,s.jsx)(s.Fragment,{children:t}):(0,s.jsxs)("div",{className:"card p-6 text-center space-y-3",children:[(0,s.jsx)(c.A,{className:"h-6 w-6 mx-auto"}),(0,s.jsx)("div",{className:"text-sm",children:"Necesitas iniciar sesi\xf3n para acceder."}),(0,s.jsx)(r(),{className:"btn",href:"/login",children:"Ir a Login"})]})}},1631:(e,a,t)=>{Promise.resolve().then(t.bind(t,6461))},6461:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>x});var s=t(4248),l=t(4564),r=t(451),n=t(9661),i=t(9410),c=t(3765);function d(e){let{value:a,title:t="C\xf3digo QR"}=e,[r,n]=(0,l.useState)(!1);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{className:"btn w-full",onClick:()=>n(!0),children:"Mostrar QR"}),r&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 grid place-items-center bg-black/50 p-4",onClick:()=>n(!1),role:"dialog","aria-modal":"true",children:(0,s.jsxs)("div",{className:"w-full max-w-sm rounded-2xl bg-white p-4 shadow-xl dark:bg-gray-900",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("div",{className:"mb-3 text-center text-lg font-semibold",children:t}),(0,s.jsx)("div",{className:"rounded-xl bg-white p-4 shadow-inner dark:bg-white",children:(0,s.jsx)(c.Ay,{value:a,size:220})}),(0,s.jsx)("div",{className:"mt-3 break-all rounded-md bg-gray-100 p-2 text-[10px] text-gray-600 dark:bg-gray-800 dark:text-gray-300",children:a}),(0,s.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,s.jsx)("button",{className:"btn-outline w-full",onClick:()=>{var e;null==(e=navigator.clipboard)||e.writeText(a)},children:"Copiar payload"}),(0,s.jsx)("button",{className:"btn w-full",onClick:()=>n(!1),children:"Cerrar"})]})]})})]})}function o(e){let{shiftId:a,fare:t}=e,l=JSON.stringify({shift:a,fare:t.code});return(0,s.jsxs)("div",{className:"space-y-2 rounded-xl border p-3",children:[(0,s.jsxs)("div",{className:"text-sm font-medium",children:[t.label," \xb7 S/ ",Number(t.base_amount).toFixed(2)]}),(0,s.jsx)(d,{value:l,title:"Cobro ".concat(t.label)})]})}var u=t(8440),m=t(8299);function x(){let{userId:e,profile:a}=(0,n.A)(),[t,c]=(0,l.useState)([]),[d,x]=(0,l.useState)(0),[h,f]=(0,l.useState)(0),[p,v]=(0,l.useState)(null),[N,b]=(0,l.useState)([]),[g,y]=(0,l.useState)(!1),j=(0,l.useRef)(new Set),w=(0,l.useMemo)(()=>{if("undefined"==typeof Audio)return null;try{return new Audio("/sounds/cash.mp3")}catch(e){return null}},[]);(0,l.useEffect)(()=>{e&&(i.N.from("driver_shifts").select("*").eq("driver_id",e).eq("status","open").maybeSingle().then(e=>{let{data:a}=e;return a&&v(a)}),(async()=>{let a=new Date().toISOString().slice(0,10),{data:t}=await i.N.from("transactions").select("id, amount, type, ts, meta").eq("driver_id",e).eq("type","ride").gte("ts","".concat(a,"T00:00:00Z")).order("ts",{ascending:!1}),s=t||[];c(s),x(s.length),f(s.reduce((e,a)=>e+Number(a.amount||0),0)),s.forEach(e=>j.current.add(e.id))})())},[e]),(0,l.useEffect)(()=>{if(!e)return;let a=i.N.channel("tx_driver_".concat(e)).on("postgres_changes",{event:"INSERT",schema:"public",table:"transactions",filter:"driver_id=eq.".concat(e)},e=>{var a,t;let s=e.new;if((null==s?void 0:s.type)==="ride"&&(!p||null==s||null==(a=s.meta)||!a.shift_id||s.meta.shift_id===p.id)&&!j.current.has(s.id)){j.current.add(s.id);let e=Number(null!=(t=s.amount)?t:0);c(a=>[{...s,amount:e},...a]),x(e=>e+1),f(a=>a+e),m.Ay.success("Pago recibido: S/ ".concat(e.toFixed(2))),null==w||w.play().catch(()=>{}),navigator.vibrate&&navigator.vibrate(60)}}).subscribe();return()=>{i.N.removeChannel(a)}},[e,null==p?void 0:p.id,w]),(0,l.useEffect)(()=>{p&&i.N.from("fares").select("id,code,label,base_amount").eq("operator_id",p.operator_id).then(e=>{let{data:a}=e;return b(a||[])})},[p]);let S=async()=>{if(e){y(!0);try{var a;let t=null==(a=(await i.N.auth.getSession()).data.session)?void 0:a.access_token,s=await (0,u.Tx)("start_shift",{driver_id:e},t);v(s.shift),m.Ay.success("Jornada iniciada"),c([]),x(0),f(0),j.current.clear()}catch(a){let e=a instanceof Error?a.message:String(a);e.includes("NO_VEHICLE_ASSIGNED")?m.Ay.error("No tienes veh\xedculo asignado"):e.includes("SHIFT_OPEN_EXISTS")?m.Ay.error("Ya tienes una jornada abierta"):m.Ay.error(e)}finally{y(!1)}}},_=async()=>{p&&(await i.N.from("driver_shifts").update({status:"closed",ended_at:new Date().toISOString()}).eq("id",p.id),v(null),m.Ay.success("Jornada finalizada"))};return(0,s.jsx)(r.A,{role:"driver",children:p?(0,s.jsxs)("div",{className:"card p-6 space-y-4",children:[(0,s.jsx)("div",{className:"text-xl font-semibold",children:"Jornada Activa"}),(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:["Conductor ",null==a?void 0:a.full_name," \xb7 Veh\xedculo ",p.vehicle_id]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,s.jsxs)("span",{className:"px-2 py-1 rounded-full bg-emerald-600/10 text-emerald-700",children:["Pasajeros: ",d]}),(0,s.jsxs)("span",{className:"px-2 py-1 rounded-full bg-blue-600/10 text-blue-700",children:["S/ ",h.toFixed(2)]})]}),(0,s.jsx)("div",{className:"mt-3 grid grid-cols-1 gap-3 md:grid-cols-3",children:N.map(e=>(0,s.jsx)(o,{shiftId:p.id,fare:e},e.id))}),(0,s.jsx)("h3",{className:"font-semibold mt-2",children:"Transacciones recientes"}),(0,s.jsxs)("ul",{className:"text-sm divide-y",children:[t.map(e=>{var a;return(0,s.jsxs)("li",{className:"py-2 flex justify-between",children:[(0,s.jsxs)("span",{children:["Pago ",(null==(a=e.meta)?void 0:a.fare_code)?"— ".concat(e.meta.fare_code):""]}),(0,s.jsxs)("span",{className:"text-green-600",children:["+S/ ",Number(e.amount).toFixed(2)]})]},e.id)}),0===t.length&&(0,s.jsx)("li",{className:"py-4 text-gray-500",children:"Sin cobros a\xfan."})]}),(0,s.jsx)("button",{className:"btn w-full mt-4",onClick:_,children:"Terminar Jornada"})]}):(0,s.jsxs)("div",{className:"max-w-xl mx-auto card p-6 space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Iniciar Jornada"}),(0,s.jsx)("button",{className:"btn w-full",disabled:g,onClick:S,children:g?"Validando…":"Iniciar Jornada"})]})})}},8440:(e,a,t)=>{"use strict";t.d(a,{Tx:()=>l,c9:()=>r});var s=t(9410);async function l(e,a,t){let s="https://exyxexamvwfvwxjjfqpl.supabase.co".replace(".co",".co/functions/v1"),l=await fetch("".concat(s,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json",...t?{Authorization:"Bearer ".concat(t)}:{}},body:JSON.stringify(a)}),r=await l.text(),n=null;try{n=r?JSON.parse(r):null}catch(e){}if(!l.ok)throw Error(n&&n.error?n.error:r||l.statusText);return n}async function r(e,a,t){var r;let n=null==(r=(await s.N.auth.getSession()).data.session)?void 0:r.access_token;if(!n)throw Error("No auth");return l("send_broadcast",{title:e,body:a,url:t},n)}},9410:(e,a,t)=>{"use strict";t.d(a,{N:()=>s});let s=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9661:(e,a,t)=>{"use strict";t.d(a,{A:()=>c,O:()=>i});var s=t(4248),l=t(4564),r=t(9410);let n=(0,l.createContext)(null);function i(e){let{children:a}=e,[t,i]=(0,l.useState)(null),[c,d]=(0,l.useState)(null),[o,u]=(0,l.useState)(null),[m,x]=(0,l.useState)(!0),[h,f]=(0,l.useState)(null),p=(0,l.useCallback)(async(e,a)=>{x(!0),f(null);try{var t;let{data:s,error:l}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();if(l&&"PGRST116"!==l.code&&console.warn("[profiles select]",l),s)return void u(s);let{data:n,error:i}=await r.N.rpc("ensure_profile",{p_id:e,p_email:null!=a?a:""});if(i)throw console.error("[ensure_profile]",i),Error("No se pudo crear/obtener el perfil");let{data:c,error:d}=await r.N.from("profiles").select("*").eq("id",e).maybeSingle();d&&console.warn("[profiles reselect]",d),u(null!=(t=null!=c?c:n)?t:null)}catch(e){u(null),f((null==e?void 0:e.message)||"Error de autenticaci\xf3n")}finally{x(!1)}},[]),v=(0,l.useCallback)(async()=>{var e,a;if(!t)return;let{data:{session:s}}=await r.N.auth.getSession();await p(t,null!=(a=null==s||null==(e=s.user)?void 0:e.email)?a:null)},[t,p]);(0,l.useEffect)(()=>{(async()=>{try{var e,a,t,s;x(!0);let{data:{session:l}}=await r.N.auth.getSession(),n=null!=(t=null==l||null==(e=l.user)?void 0:e.id)?t:null,c=null!=(s=null==l||null==(a=l.user)?void 0:a.email)?s:null;i(n),d(c),n?await p(n,c):x(!1)}catch(e){f((null==e?void 0:e.message)||"Error inicializando sesi\xf3n"),x(!1)}})();let{data:e}=r.N.auth.onAuthStateChange(async(e,a)=>{var t,s,l,r;let n=null!=(l=null==a||null==(t=a.user)?void 0:t.id)?l:null,c=null!=(r=null==a||null==(s=a.user)?void 0:s.email)?r:null;i(n),d(c),n?await p(n,c):(u(null),x(!1))});return()=>{e.subscription.unsubscribe()}},[p]);let N=async()=>{await r.N.auth.signOut(),i(null),d(null),u(null)};return(0,s.jsx)(n.Provider,{value:{userId:t,email:c,profile:o,loading:m,error:h,refreshProfile:v,signOut:N},children:a})}let c=()=>{let e=(0,l.useContext)(n);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[835,642,299,682,647,516,358],()=>e(e.s=1631)),_N_E=e.O()}]);