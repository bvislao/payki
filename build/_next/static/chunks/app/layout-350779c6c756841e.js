(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{1235:(e,r,t)=>{"use strict";t.d(r,{default:()=>n});var a=t(4248),i=t(8299);function n(){return(0,a.jsx)(i.l$,{position:"top-center",toastOptions:{duration:3e3,style:{fontSize:"0.9rem",borderRadius:"0.75rem",background:"var(--toast-bg)",color:"var(--toast-fg)"},success:{iconTheme:{primary:"#10b981",secondary:"white"}},error:{iconTheme:{primary:"#ef4444",secondary:"white"}}}})}},2498:(e,r,t)=>{"use strict";t.d(r,{default:()=>d});var a=t(4248),i=t(9661),n=t(7637);function s(){let{pending:e}=(0,n.M)();return e<=0?null:(0,a.jsx)("div",{className:"fixed inset-0 z-[9999] bg-black/40 backdrop-blur-sm flex items-center justify-center",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 rounded-2xl bg-white/90 dark:bg-gray-900/90 px-5 py-3 shadow-xl",children:[(0,a.jsx)("span",{className:"inline-block h-4 w-4 animate-spin rounded-full border-2 border-gray-400 border-t-transparent"}),(0,a.jsx)("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Cargando…"})]})})}var l=t(8650);let o=(0,t(5112).A)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);function c(e){let{children:r}=e,{loading:t,error:n,refreshProfile:s}=(0,i.A)();return t?(0,a.jsxs)("div",{className:"fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-white/80 dark:bg-gray-950/80 backdrop-blur",children:[(0,a.jsx)(l.A,{className:"h-8 w-8 animate-spin"}),(0,a.jsx)("div",{className:"mt-3 text-sm text-gray-600 dark:text-gray-300",children:"Cargando tu sesi\xf3n…"})]}):n?(0,a.jsx)("div",{className:"min-h-dvh flex items-center justify-center",children:(0,a.jsxs)("div",{className:"card p-6 max-w-md text-center space-y-3",children:[(0,a.jsx)(o,{className:"h-6 w-6 mx-auto text-amber-500"}),(0,a.jsx)("h2",{className:"text-lg font-semibold",children:"No pudimos obtener tu perfil"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:n}),(0,a.jsx)("button",{className:"btn w-full",onClick:()=>s(),children:"Reintentar"})]})}):(0,a.jsx)(a.Fragment,{children:r})}function d(e){let{children:r}=e;return(0,a.jsx)(n.o,{children:(0,a.jsx)(i.O,{children:(0,a.jsxs)(c,{children:[r,(0,a.jsx)(s,{})]})})})}},5112:(e,r,t)=>{"use strict";t.d(r,{A:()=>o});var a=t(4564);let i=e=>{let r=e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,r,t)=>t?t.toUpperCase():r.toLowerCase());return r.charAt(0).toUpperCase()+r.slice(1)},n=function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter((e,r,t)=>!!e&&""!==e.trim()&&t.indexOf(e)===r).join(" ").trim()};var s={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};let l=(0,a.forwardRef)((e,r)=>{let{color:t="currentColor",size:i=24,strokeWidth:l=2,absoluteStrokeWidth:o,className:c="",children:d,iconNode:u,...h}=e;return(0,a.createElement)("svg",{ref:r,...s,width:i,height:i,stroke:t,strokeWidth:o?24*Number(l)/Number(i):l,className:n("lucide",c),...!d&&!(e=>{for(let r in e)if(r.startsWith("aria-")||"role"===r||"title"===r)return!0})(h)&&{"aria-hidden":"true"},...h},[...u.map(e=>{let[r,t]=e;return(0,a.createElement)(r,t)}),...Array.isArray(d)?d:[d]])}),o=(e,r)=>{let t=(0,a.forwardRef)((t,s)=>{let{className:o,...c}=t;return(0,a.createElement)(l,{ref:s,iconNode:r,className:n("lucide-".concat(i(e).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()),"lucide-".concat(e),o),...c})});return t.displayName=i(e),t}},5519:(e,r,t)=>{"use strict";var a=t(2455);t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}})},5763:()=>{},7637:(e,r,t)=>{"use strict";t.d(r,{M:()=>l,o:()=>s});var a=t(4248),i=t(4564);let n=(0,i.createContext)(null);function s(e){let{children:r}=e,[t,s]=(0,i.useState)(0),l=()=>s(e=>e+1),o=()=>s(e=>Math.max(0,e-1));(0,i.useEffect)(()=>{let e=window.fetch;return window.fetch=async function(){for(var r=arguments.length,t=Array(r),a=0;a<r;a++)t[a]=arguments[a];s(e=>e+1);try{return await e(...t)}finally{s(e=>Math.max(0,e-1))}},()=>{window.fetch=e}},[]);let c=(0,i.useMemo)(()=>({pending:t,start:l,stop:o}),[t]);return(0,a.jsx)(n.Provider,{value:c,children:r})}let l=()=>{let e=(0,i.useContext)(n);if(!e)throw Error("LoadingProvider missing");return e}},7882:(e,r,t)=>{"use strict";t.d(r,{default:()=>y});var a=t(4248),i=t(7642),n=t.n(i),s=t(5519),l=t(9661),o=t(4564),c=t(8299),d=t(5112);let u=(0,d.A)("bell-off",[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M17 17H4a1 1 0 0 1-.74-1.673C4.59 13.956 6 12.499 6 8a6 6 0 0 1 .258-1.742",key:"178tsu"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M8.668 3.01A6 6 0 0 1 18 8c0 2.687.77 4.653 1.707 6.05",key:"1hqiys"}]]);var h=t(8650);let m=(0,d.A)("bell",[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]]);var p=t(9410);async function f(){return"serviceWorker"in navigator?await navigator.serviceWorker.register("/sw.js"):null}async function g(e,r){let t=await navigator.serviceWorker.ready,a=function(e){if(!e)throw Error("VAPID public key is empty/undefined");let r=e.trim().replace(/^"+|"+$/g,"").replace(/\s+/g,"").replace(/-/g,"+").replace(/_/g,"/"),t=r.length%4;t&&(r+="=".repeat(4-t));let a="";try{a=atob(r)}catch(e){throw Error("Invalid VAPID public key (not Base64/Base64URL).")}let i=new Uint8Array(a.length);for(let e=0;e<a.length;e++)i[e]=a.charCodeAt(e);return i}(e),i=await t.pushManager.getSubscription();if(i){var n;let e=await (null==(n=i.getOptions)?void 0:n.call(i));(null==e?void 0:e.applicationServerKey)&&new Uint8Array(e.applicationServerKey).toString()===a.toString()||await i.unsubscribe()}let s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a}),l=s.toJSON();await r({endpoint:s.endpoint,p256dh:l.keys.p256dh,auth:l.keys.auth})}function x(){var e;let r=[],t=window.isSecureContext||"https:"===location.protocol;t||"localhost"===location.hostname||r.push("El sitio no est\xe1 en HTTPS.");let a="serviceWorker"in navigator;a||r.push("Este navegador no soporta Service Worker.");let i="PushManager"in window;i||r.push("Este navegador no soporta la API de Push.");let n=null==(e=Notification)?void 0:e.permission;"denied"===n&&r.push("Las notificaciones est\xe1n bloqueadas para este sitio.");let s=navigator.userAgent||"",l=/iPad|iPhone|iPod/.test(s)&&!("MSStream"in window),o=window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone;return l&&!o&&r.push("En iOS debes instalar la PWA en la pantalla de inicio para recibir push."),{ok:0===r.length,reasons:r,info:{isSecure:t,hasSW:a,hasPush:i,perm:n,isIOS:l,isStandalone:o}}}function b(){let{userId:e}=(0,l.A)(),[r,t]=(0,o.useState)(!1),[i,n]=(0,o.useState)(!0),[s,d]=(0,o.useState)("default"),[b,v]=(0,o.useState)(!1);(0,o.useEffect)(()=>{n(x().ok),"Notification"in window&&d(Notification.permission),(async()=>{try{if(!("serviceWorker"in navigator)||!("PushManager"in window))return;let e=await navigator.serviceWorker.ready,r=await e.pushManager.getSubscription();v(!!r)}catch(e){}})()},[e]);let w=async()=>{let r=x();if(!r.ok)return void c.Ay.error("Navegador no soportado para Web Push:\n- "+r.reasons.join("\n- "));if(!e)return c.Ay.error("Inicia sesi\xf3n primero");try{if(t(!0),await f(),"Notification"in window){let e=Notification.permission;if("default"===e&&(e=await Notification.requestPermission()),d(e),"granted"!==e)return void c.Ay.error("Permiso de notificaciones denegado")}await f(),await g("BPo7RRimYDKGzaeHg7riTHmV2QJlY5JmvMO-dakefvSW_CU6kxk8NH5tiiUDiDdHETsmhpn5qG8pOdK2wnk7MHw",async r=>{await p.N.from("push_subscriptions").upsert({user_id:e,endpoint:r.endpoint,p256dh:r.p256dh,auth:r.auth,user_agent:navigator.userAgent},{onConflict:"endpoint"})}),v(!0),c.Ay.success("Notificaciones activadas")}catch(e){c.Ay.error(e instanceof Error?e.message:String(e))}finally{t(!1)}},y=async()=>{try{t(!0);let e=await navigator.serviceWorker.ready,r=await e.pushManager.getSubscription();if(r){let e=r.endpoint;await r.unsubscribe().catch(()=>{}),await p.N.from("push_subscriptions").delete().eq("endpoint",e)}v(!1),c.Ay.success("Notificaciones desactivadas")}catch(e){c.Ay.error(e instanceof Error?e.message:String(e))}finally{t(!1)}};return i?b?(0,a.jsxs)("button",{className:"btn-outline",onClick:y,disabled:r,title:"Desactivar notificaciones","aria-label":"Desactivar notificaciones",children:[r?(0,a.jsx)(h.A,{className:"h-4 w-4 mr-2 animate-spin"}):(0,a.jsx)(u,{className:"h-4 w-4 mr-2"}),"Desactivar Push"]}):(0,a.jsxs)("button",{className:"btn-outline",onClick:w,disabled:r||"denied"===s,title:"denied"===s?"Permiso denegado por el usuario":"Activar notificaciones","aria-label":"Activar notificaciones",children:[r?(0,a.jsx)(h.A,{className:"h-4 w-4 mr-2 animate-spin"}):(0,a.jsx)(m,{className:"h-4 w-4 mr-2"}),"Activar Push"]}):(0,a.jsxs)("button",{className:"btn-outline opacity-60 cursor-not-allowed",disabled:!0,title:"Web Push no soportado en este navegador",children:[(0,a.jsx)(u,{className:"h-4 w-4 mr-2"}),"Push no disponible"]})}let v=[{href:"/user",label:"Usuario",roles:["passenger","admin"]},{href:"/driver",label:"Conductor",roles:["driver","admin"]},{href:"/admin",label:"Admin",roles:["admin"]}];function w(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return r.filter(Boolean).join(" ")}function y(){var e;let{userId:r,email:t,profile:i,signOut:c}=(0,l.A)(),d=(0,s.usePathname)(),[u,h]=(0,o.useState)(!1);(0,o.useEffect)(()=>{h(!1)},[d]);let m=null!=(e=null==i?void 0:i.role)?e:null,p=v.filter(e=>!e.roles||m&&e.roles.includes(m));return(0,a.jsxs)("nav",{className:"container flex items-center justify-between h-14",children:[(0,a.jsxs)(n(),{href:"/","aria-label":"Inicio",className:"flex items-center gap-2 shrink-0",children:[(0,a.jsx)("img",{src:"/logo-bg.svg",alt:"PAYKI",className:"h-7 w-auto"}),(0,a.jsx)("span",{className:"sr-only",children:"PAYKI"})]}),(0,a.jsxs)("div",{className:"hidden md:flex items-center gap-2",children:[p.map(e=>(0,a.jsx)(n(),{href:e.href,className:w("px-3 py-1.5 rounded-xl text-sm transition-colors",d.startsWith(e.href)?"bg-emerald-600 text-white":"hover:bg-gray-100 dark:hover:bg-gray-800"),children:e.label},e.href)),r&&(0,a.jsx)(b,{}),r?(0,a.jsx)("button",{className:"btn-outline",onClick:async()=>{await c(),window.location.href="/"},"aria-label":"Cerrar sesi\xf3n",children:"Cerrar sesi\xf3n"}):(0,a.jsx)(n(),{className:"btn",href:"/login",children:"Login"})]}),(0,a.jsx)("div",{className:"hidden md:block ml-3",children:r&&(0,a.jsxs)("span",{className:"text-xs text-gray-600 dark:text-gray-300",children:["Hola ",(0,a.jsx)("b",{className:"truncate max-w-[220px] inline-block align-bottom",children:t})," \xb7 ",(0,a.jsx)("b",{children:m})]})}),(0,a.jsxs)("button",{className:"md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800",onClick:()=>h(e=>!e),"aria-expanded":u,"aria-controls":"mobile-menu","aria-label":"Abrir men\xfa",children:[(0,a.jsx)("span",{className:"sr-only",children:"Abrir men\xfa"}),(0,a.jsx)("svg",{width:"22",height:"22",viewBox:"0 0 24 24",fill:"none",className:"stroke-current",children:(0,a.jsx)("path",{d:"M4 7h16M4 12h16M4 17h16",strokeWidth:"1.8",strokeLinecap:"round"})})]}),(0,a.jsx)("div",{id:"mobile-menu",className:w("md:hidden absolute left-0 right-0 top-14 z-40 border-b border-gray-200/60 dark:border-gray-800 bg-white/95 dark:bg-gray-950/95 backdrop-blur",u?"block":"hidden"),children:(0,a.jsxs)("div",{className:"container py-3 flex flex-col gap-2",children:[r&&(0,a.jsxs)("div",{className:"text-xs text-gray-600 dark:text-gray-300 px-2",children:["Hola ",(0,a.jsx)("b",{children:t})," \xb7 ",(0,a.jsx)("b",{children:m})]}),p.map(e=>(0,a.jsx)(n(),{href:e.href,className:w("px-3 py-2 rounded-xl text-sm",d.startsWith(e.href)?"bg-emerald-600 text-white":"hover:bg-gray-100 dark:hover:bg-gray-800"),children:e.label},e.href)),(0,a.jsxs)("div",{className:"flex items-center gap-2 px-2",children:[r&&(0,a.jsx)(b,{}),r?(0,a.jsx)("button",{className:"btn-outline w-full",onClick:async()=>{await c(),window.location.href="/"},children:"Cerrar sesi\xf3n"}):(0,a.jsx)(n(),{className:"btn w-full",href:"/login",children:"Login"})]})]})})]})}},8243:(e,r,t)=>{Promise.resolve().then(t.bind(t,2498)),Promise.resolve().then(t.bind(t,9523)),Promise.resolve().then(t.bind(t,7882)),Promise.resolve().then(t.bind(t,8787)),Promise.resolve().then(t.bind(t,1235)),Promise.resolve().then(t.t.bind(t,5763,23))},8650:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});let a=(0,t(5112).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},8787:(e,r,t)=>{"use strict";t.d(r,{default:()=>i});var a=t(4564);function i(){return(0,a.useEffect)(()=>{"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js",{scope:"/"}).catch(console.error)},[]),null}},9410:(e,r,t)=>{"use strict";t.d(r,{N:()=>a});let a=(0,t(5835).createBrowserClient)("https://exyxexamvwfvwxjjfqpl.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eXhleGFtdndmdnd4ampmcXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5MzEsImV4cCI6MjA3NDgyMzkzMX0.JW0haLRNKznqB0C5zMx9wF7_u6RTZQsD6WwgqpHHVIU")},9523:(e,r,t)=>{"use strict";t.d(r,{default:()=>s});var a=t(4248),i=t(7642),n=t.n(i);function s(){return(0,a.jsxs)("footer",{className:"container py-8 text-xs text-center text-gray-500",children:["Hecho con ",(0,a.jsx)("span",{"aria-label":"amor",title:"amor",children:"❤"})," —"," ",(0,a.jsx)(n(),{href:"https://github.com/bvislao/payki",className:"underline hover:opacity-80",target:"_blank",rel:"noopener noreferrer",children:"C\xf3digo GitHub"}),"  "," \xa9 ",new Date().getFullYear()," PAYKI"]})}},9661:(e,r,t)=>{"use strict";t.d(r,{A:()=>o,O:()=>l});var a=t(4248),i=t(4564),n=t(9410);let s=(0,i.createContext)(null);function l(e){let{children:r}=e,[t,l]=(0,i.useState)(null),[o,c]=(0,i.useState)(null),[d,u]=(0,i.useState)(null),[h,m]=(0,i.useState)(!0),[p,f]=(0,i.useState)(null),g=(0,i.useCallback)(async(e,r)=>{m(!0),f(null);try{var t;let{data:a,error:i}=await n.N.from("profiles").select("*").eq("id",e).maybeSingle();if(i&&"PGRST116"!==i.code&&console.warn("[profiles select]",i),a)return void u(a);let{data:s,error:l}=await n.N.rpc("ensure_profile",{p_id:e,p_email:null!=r?r:""});if(l)throw console.error("[ensure_profile]",l),Error("No se pudo crear/obtener el perfil");let{data:o,error:c}=await n.N.from("profiles").select("*").eq("id",e).maybeSingle();c&&console.warn("[profiles reselect]",c),u(null!=(t=null!=o?o:s)?t:null)}catch(e){u(null),f((null==e?void 0:e.message)||"Error de autenticaci\xf3n")}finally{m(!1)}},[]),x=(0,i.useCallback)(async()=>{var e,r;if(!t)return;let{data:{session:a}}=await n.N.auth.getSession();await g(t,null!=(r=null==a||null==(e=a.user)?void 0:e.email)?r:null)},[t,g]);(0,i.useEffect)(()=>{(async()=>{try{var e,r,t,a;m(!0);let{data:{session:i}}=await n.N.auth.getSession(),s=null!=(t=null==i||null==(e=i.user)?void 0:e.id)?t:null,o=null!=(a=null==i||null==(r=i.user)?void 0:r.email)?a:null;l(s),c(o),s?await g(s,o):m(!1)}catch(e){f((null==e?void 0:e.message)||"Error inicializando sesi\xf3n"),m(!1)}})();let{data:e}=n.N.auth.onAuthStateChange(async(e,r)=>{var t,a,i,n;let s=null!=(i=null==r||null==(t=r.user)?void 0:t.id)?i:null,o=null!=(n=null==r||null==(a=r.user)?void 0:a.email)?n:null;l(s),c(o),s?await g(s,o):(u(null),m(!1))});return()=>{e.subscription.unsubscribe()}},[g]);let b=async()=>{await n.N.auth.signOut(),l(null),c(null),u(null)};return(0,a.jsx)(s.Provider,{value:{userId:t,email:o,profile:d,loading:h,error:p,refreshProfile:x,signOut:b},children:r})}let o=()=>{let e=(0,i.useContext)(s);if(!e)throw Error("AuthProvider missing");return e}}},e=>{e.O(0,[360,835,642,299,647,516,358],()=>e(e.s=8243)),_N_E=e.O()}]);